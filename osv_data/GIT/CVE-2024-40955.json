{"schema_version":"1.7.3","id":"CVE-2024-40955","published":"2024-07-12T12:31:58.328Z","modified":"2025-11-20T04:53:03.845803Z","summary":"ext4: fix slab-out-of-bounds in ext4_mb_find_good_group_avg_frag_lists()","details":"In the Linux kernel, the following vulnerability has been resolved:\n\next4: fix slab-out-of-bounds in ext4_mb_find_good_group_avg_frag_lists()\n\nWe can trigger a slab-out-of-bounds with the following commands:\n\n    mkfs.ext4 -F /dev/$disk 10G\n    mount /dev/$disk /tmp/test\n    echo 2147483647 > /sys/fs/ext4/$disk/mb_group_prealloc\n    echo test > /tmp/test/file && sync\n\n==================================================================\nBUG: KASAN: slab-out-of-bounds in ext4_mb_find_good_group_avg_frag_lists+0x8a/0x200 [ext4]\nRead of size 8 at addr ffff888121b9d0f0 by task kworker/u2:0/11\nCPU: 0 PID: 11 Comm: kworker/u2:0 Tainted: GL 6.7.0-next-20240118 #521\nCall Trace:\n dump_stack_lvl+0x2c/0x50\n kasan_report+0xb6/0xf0\n ext4_mb_find_good_group_avg_frag_lists+0x8a/0x200 [ext4]\n ext4_mb_regular_allocator+0x19e9/0x2370 [ext4]\n ext4_mb_new_blocks+0x88a/0x1370 [ext4]\n ext4_ext_map_blocks+0x14f7/0x2390 [ext4]\n ext4_map_blocks+0x569/0xea0 [ext4]\n ext4_do_writepages+0x10f6/0x1bc0 [ext4]\n[...]\n==================================================================\n\nThe flow of issue triggering is as follows:\n\n// Set s_mb_group_prealloc to 2147483647 via sysfs\next4_mb_new_blocks\n  ext4_mb_normalize_request\n    ext4_mb_normalize_group_request\n      ac->ac_g_ex.fe_len = EXT4_SB(sb)->s_mb_group_prealloc\n  ext4_mb_regular_allocator\n    ext4_mb_choose_next_group\n      ext4_mb_choose_next_group_best_avail\n        mb_avg_fragment_size_order\n          order = fls(len) - 2 = 29\n        ext4_mb_find_good_group_avg_frag_lists\n          frag_list = &sbi->s_mb_avg_fragment_size[order]\n          if (list_empty(frag_list)) // Trigger SOOB!\n\nAt 4k block size, the length of the s_mb_avg_fragment_size list is 14,\nbut an oversized s_mb_group_prealloc is set, causing slab-out-of-bounds\nto be triggered by an attempt to access an element at index 29.\n\nAdd a new attr_id attr_clusters_in_group with values in the range\n[0, sbi->s_clusters_per_group] and declare mb_group_prealloc as\nthat type to fix the issue. In addition avoid returning an order\nfrom mb_avg_fragment_size_order() greater than MB_NUM_ORDERS(sb)\nand reduce some useless loops.","affected":[{"ranges":[{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"7e170922f06bf46effa7c57f6035fc463d6edc7e"},{"fixed":"677ff4589f1501578fa903a25bb14831d0607992"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"7e170922f06bf46effa7c57f6035fc463d6edc7e"},{"fixed":"b829687ae1229224262bcabf49accfa2dbf8db06"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"7e170922f06bf46effa7c57f6035fc463d6edc7e"},{"fixed":"13df4d44a3aaabe61cd01d277b6ee23ead2a5206"}]}],"versions":["v6.4","v6.4-rc6","v6.4-rc7","v6.5","v6.5-rc1","v6.5-rc2","v6.5-rc3","v6.5-rc4","v6.5-rc5","v6.5-rc6","v6.5-rc7","v6.6","v6.6-rc1","v6.6-rc2","v6.6-rc3","v6.6-rc4","v6.6-rc5","v6.6-rc6","v6.6-rc7","v6.6.1","v6.6.10","v6.6.11","v6.6.12","v6.6.13","v6.6.14","v6.6.15","v6.6.16","v6.6.17","v6.6.18","v6.6.19","v6.6.2","v6.6.20","v6.6.21","v6.6.22","v6.6.23","v6.6.24","v6.6.25","v6.6.26","v6.6.27","v6.6.28","v6.6.29","v6.6.3","v6.6.30","v6.6.31","v6.6.32","v6.6.33","v6.6.34","v6.6.35","v6.6.4","v6.6.5","v6.6.6","v6.6.7","v6.6.8","v6.6.9","v6.7","v6.7-rc1","v6.7-rc2","v6.7-rc3","v6.7-rc4","v6.7-rc5","v6.7-rc6","v6.7-rc7","v6.7-rc8","v6.8","v6.8-rc1","v6.8-rc2","v6.8-rc3","v6.8-rc4","v6.8-rc5","v6.8-rc6","v6.8-rc7","v6.9","v6.9-rc1","v6.9-rc2","v6.9-rc3","v6.9-rc4","v6.9-rc5","v6.9-rc6","v6.9-rc7","v6.9.1","v6.9.2","v6.9.3","v6.9.4","v6.9.5","v6.9.6"],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2024-40955.json","vanir_signatures":[{"deprecated":false,"digest":{"line_hashes":["39721644310292476363521808788118789979","170823731717029789929430966074186030449","245307119853743255987417845997331499698","85088641324527079685729860382466532748","59823204139153382254078337305205703124","131156671546782507748032344488177916783","6946821057348556959740232985799205526","23385510778012978651460937013588446371"],"threshold":0.9},"id":"CVE-2024-40955-72083d52","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@b829687ae1229224262bcabf49accfa2dbf8db06","target":{"file":"fs/ext4/mballoc.c"}},{"deprecated":false,"digest":{"line_hashes":["273084477898881614758550476315966995412","91142723389001659805969726754605584575","119305993483715813409617938695322949718","272442390459900454211091663456245529524","118659253683007082055754902507247617655","201360672329705427603370013258565436337","313294583667446827671616155160609800135","168493339920354618367048785774773577884","80017268624528881303212108903538348781","146750978022048267525125673610664064605","121984723042494256220399909069271023893","167819207698330529782805405548045071791","210109133161780438675722325473112388723","126207171614939410608443581734377986864","61458173896832370154729387451534113905","226794527639468943759366845134245697214","69186247518411810698614541479831846233","335225710081102766234704518254295414477","332272613640865980724139470006235373538","325028783880334738337636736504705288504","251027205035095671694075225144677502578","102951606183141966508323256673479468558","35718086299916677030030056880631192288"],"threshold":0.9},"id":"CVE-2024-40955-79590735","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@b829687ae1229224262bcabf49accfa2dbf8db06","target":{"file":"fs/ext4/sysfs.c"}},{"deprecated":false,"digest":{"function_hash":"321857709272258536107459065484291437352","length":2150},"id":"CVE-2024-40955-854ad84a","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@b829687ae1229224262bcabf49accfa2dbf8db06","target":{"file":"fs/ext4/sysfs.c","function":"ext4_attr_show"}},{"deprecated":false,"digest":{"function_hash":"153791406055196987960668338123604578856","length":181},"id":"CVE-2024-40955-86c4c02e","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@b829687ae1229224262bcabf49accfa2dbf8db06","target":{"file":"fs/ext4/mballoc.c","function":"mb_avg_fragment_size_order"}},{"deprecated":false,"digest":{"function_hash":"336786202378473398330914870493466063143","length":1053},"id":"CVE-2024-40955-cace8cdd","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@b829687ae1229224262bcabf49accfa2dbf8db06","target":{"file":"fs/ext4/sysfs.c","function":"ext4_attr_store"}},{"deprecated":false,"digest":{"function_hash":"91919650547634307144125065300556945468","length":1177},"id":"CVE-2024-40955-e61176a2","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@b829687ae1229224262bcabf49accfa2dbf8db06","target":{"file":"fs/ext4/mballoc.c","function":"ext4_mb_choose_next_group_best_avail"}}]}},{"package":{"name":"Kernel","ecosystem":"Linux"},"ranges":[{"type":"ECOSYSTEM","events":[{"introduced":"6.5.0"},{"fixed":"6.6.36"}]},{"type":"ECOSYSTEM","events":[{"introduced":"6.7.0"},{"fixed":"6.9.7"}]}],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2024-40955.json"}}],"references":[{"type":"PACKAGE","url":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"},{"type":"WEB","url":"https://git.kernel.org/stable/c/13df4d44a3aaabe61cd01d277b6ee23ead2a5206"},{"type":"WEB","url":"https://git.kernel.org/stable/c/677ff4589f1501578fa903a25bb14831d0607992"},{"type":"WEB","url":"https://git.kernel.org/stable/c/b829687ae1229224262bcabf49accfa2dbf8db06"}]}