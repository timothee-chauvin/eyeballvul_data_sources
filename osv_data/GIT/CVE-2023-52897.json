{"schema_version":"1.7.3","id":"CVE-2023-52897","published":"2024-08-21T06:10:37Z","modified":"2025-10-21T14:56:55.148953Z","summary":"btrfs: qgroup: do not warn on record without old_roots populated","details":"In the Linux kernel, the following vulnerability has been resolved:\n\nbtrfs: qgroup: do not warn on record without old_roots populated\n\n[BUG]\nThere are some reports from the mailing list that since v6.1 kernel, the\nWARN_ON() inside btrfs_qgroup_account_extent() gets triggered during\nrescan:\n\n  WARNING: CPU: 3 PID: 6424 at fs/btrfs/qgroup.c:2756 btrfs_qgroup_account_extents+0x1ae/0x260 [btrfs]\n  CPU: 3 PID: 6424 Comm: snapperd Tainted: P           OE      6.1.2-1-default #1 openSUSE Tumbleweed 05c7a1b1b61d5627475528f71f50444637b5aad7\n  RIP: 0010:btrfs_qgroup_account_extents+0x1ae/0x260 [btrfs]\n  Call Trace:\n   <TASK>\n  btrfs_commit_transaction+0x30c/0xb40 [btrfs c39c9c546c241c593f03bd6d5f39ea1b676250f6]\n   ? start_transaction+0xc3/0x5b0 [btrfs c39c9c546c241c593f03bd6d5f39ea1b676250f6]\n  btrfs_qgroup_rescan+0x42/0xc0 [btrfs c39c9c546c241c593f03bd6d5f39ea1b676250f6]\n   btrfs_ioctl+0x1ab9/0x25c0 [btrfs c39c9c546c241c593f03bd6d5f39ea1b676250f6]\n   ? __rseq_handle_notify_resume+0xa9/0x4a0\n   ? mntput_no_expire+0x4a/0x240\n   ? __seccomp_filter+0x319/0x4d0\n   __x64_sys_ioctl+0x90/0xd0\n   do_syscall_64+0x5b/0x80\n   ? syscall_exit_to_user_mode+0x17/0x40\n   ? do_syscall_64+0x67/0x80\n  entry_SYSCALL_64_after_hwframe+0x63/0xcd\n  RIP: 0033:0x7fd9b790d9bf\n   </TASK>\n\n[CAUSE]\nSince commit e15e9f43c7ca (\"btrfs: introduce\nBTRFS_QGROUP_RUNTIME_FLAG_NO_ACCOUNTING to skip qgroup accounting\"), if\nour qgroup is already in inconsistent state, we will no longer do the\ntime-consuming backref walk.\n\nThis can leave some qgroup records without a valid old_roots ulist.\nNormally this is fine, as btrfs_qgroup_account_extents() would also skip\nthose records if we have NO_ACCOUNTING flag set.\n\nBut there is a small window, if we have NO_ACCOUNTING flag set, and\ninserted some qgroup_record without a old_roots ulist, but then the user\ntriggered a qgroup rescan.\n\nDuring btrfs_qgroup_rescan(), we firstly clear NO_ACCOUNTING flag, then\ncommit current transaction.\n\nAnd since we have a qgroup_record with old_roots = NULL, we trigger the\nWARN_ON() during btrfs_qgroup_account_extents().\n\n[FIX]\nUnfortunately due to the introduction of NO_ACCOUNTING flag, the\nassumption that every qgroup_record would have its old_roots populated\nis no longer correct.\n\nFix the false alerts and drop the WARN_ON().","affected":[{"ranges":[{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"e15e9f43c7ca25603fcf4c20d44ec777726f1034"},{"fixed":"bb2c2e62539f2b63c5e0beb51501d328260c7595"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"e15e9f43c7ca25603fcf4c20d44ec777726f1034"},{"fixed":"75181406b4eafacc531ff2ee5fb032bd93317e2b"}]}],"versions":["v6.0","v6.1","v6.1-rc1","v6.1-rc2","v6.1-rc3","v6.1-rc4","v6.1-rc5","v6.1-rc6","v6.1-rc7","v6.1-rc8","v6.1.1","v6.1.2","v6.1.3","v6.1.4","v6.1.5","v6.1.6","v6.1.7"],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2023-52897.json","vanir_signatures":[{"deprecated":false,"digest":{"function_hash":"266757706377593618902991757928007548883","length":1217},"id":"CVE-2023-52897-3b233389","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@bb2c2e62539f2b63c5e0beb51501d328260c7595","target":{"file":"fs/btrfs/qgroup.c","function":"btrfs_qgroup_account_extents"}},{"deprecated":false,"digest":{"function_hash":"318253056261228408820990186442589731240","length":1323},"id":"CVE-2023-52897-6264ee44","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@75181406b4eafacc531ff2ee5fb032bd93317e2b","target":{"file":"fs/btrfs/qgroup.c","function":"btrfs_qgroup_account_extents"}},{"deprecated":false,"digest":{"line_hashes":["67821475638367676404016561592384352930","214928058543830446973456585841176279158","59889967589629904814909839944697349201","242936938678591585934304507982711609897"],"threshold":0.9},"id":"CVE-2023-52897-b38e02ce","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@75181406b4eafacc531ff2ee5fb032bd93317e2b","target":{"file":"fs/btrfs/qgroup.c"}},{"deprecated":false,"digest":{"line_hashes":["95284346372284379696531218103686347232","172353770038680277711971126654859855520","151264429046052174390979411093101571716","88798191734397534401531679547202381303"],"threshold":0.9},"id":"CVE-2023-52897-ef2c4181","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@bb2c2e62539f2b63c5e0beb51501d328260c7595","target":{"file":"fs/btrfs/qgroup.c"}}]}},{"package":{"name":"Kernel","ecosystem":"Linux"},"ranges":[{"type":"ECOSYSTEM","events":[{"introduced":"6.1.0"},{"fixed":"6.1.8"}]}],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2023-52897.json"}}],"references":[{"type":"PACKAGE","url":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"},{"type":"WEB","url":"https://git.kernel.org/stable/c/75181406b4eafacc531ff2ee5fb032bd93317e2b"},{"type":"WEB","url":"https://git.kernel.org/stable/c/bb2c2e62539f2b63c5e0beb51501d328260c7595"}]}