{"schema_version":"1.7.3","id":"CVE-2025-40064","published":"2025-10-28T11:48:35Z","modified":"2025-10-28T20:09:03.995359Z","summary":"smc: Fix use-after-free in __pnet_find_base_ndev().","details":"In the Linux kernel, the following vulnerability has been resolved:\n\nsmc: Fix use-after-free in __pnet_find_base_ndev().\n\nsyzbot reported use-after-free of net_device in __pnet_find_base_ndev(),\nwhich was called during connect(). [0]\n\nsmc_pnet_find_ism_resource() fetches sk_dst_get(sk)->dev and passes\ndown to pnet_find_base_ndev(), where RTNL is held.  Then, UAF happened\nat __pnet_find_base_ndev() when the dev is first used.\n\nThis means dev had already been freed before acquiring RTNL in\npnet_find_base_ndev().\n\nWhile dev is going away, dst->dev could be swapped with blackhole_netdev,\nand the dev's refcnt by dst will be released.\n\nWe must hold dev's refcnt before calling smc_pnet_find_ism_resource().\n\nAlso, smc_pnet_find_roce_resource() has the same problem.\n\nLet's use __sk_dst_get() and dst_dev_rcu() in the two functions.\n\n[0]:\nBUG: KASAN: use-after-free in __pnet_find_base_ndev+0x1b1/0x1c0 net/smc/smc_pnet.c:926\nRead of size 1 at addr ffff888036bac33a by task syz.0.3632/18609\n\nCPU: 1 UID: 0 PID: 18609 Comm: syz.0.3632 Not tainted syzkaller #0 PREEMPT(full)\nHardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/18/2025\nCall Trace:\n <TASK>\n dump_stack_lvl+0x189/0x250 lib/dump_stack.c:120\n print_address_description mm/kasan/report.c:378 [inline]\n print_report+0xca/0x240 mm/kasan/report.c:482\n kasan_report+0x118/0x150 mm/kasan/report.c:595\n __pnet_find_base_ndev+0x1b1/0x1c0 net/smc/smc_pnet.c:926\n pnet_find_base_ndev net/smc/smc_pnet.c:946 [inline]\n smc_pnet_find_ism_by_pnetid net/smc/smc_pnet.c:1103 [inline]\n smc_pnet_find_ism_resource+0xef/0x390 net/smc/smc_pnet.c:1154\n smc_find_ism_device net/smc/af_smc.c:1030 [inline]\n smc_find_proposal_devices net/smc/af_smc.c:1115 [inline]\n __smc_connect+0x372/0x1890 net/smc/af_smc.c:1545\n smc_connect+0x877/0xd90 net/smc/af_smc.c:1715\n __sys_connect_file net/socket.c:2086 [inline]\n __sys_connect+0x313/0x440 net/socket.c:2105\n __do_sys_connect net/socket.c:2111 [inline]\n __se_sys_connect net/socket.c:2108 [inline]\n __x64_sys_connect+0x7a/0x90 net/socket.c:2108\n do_syscall_x64 arch/x86/entry/syscall_64.c:63 [inline]\n do_syscall_64+0xfa/0x3b0 arch/x86/entry/syscall_64.c:94\n entry_SYSCALL_64_after_hwframe+0x77/0x7f\nRIP: 0033:0x7f47cbf8eba9\nCode: ff ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 a8 ff ff ff f7 d8 64 89 01 48\nRSP: 002b:00007f47ccdb1038 EFLAGS: 00000246 ORIG_RAX: 000000000000002a\nRAX: ffffffffffffffda RBX: 00007f47cc1d5fa0 RCX: 00007f47cbf8eba9\nRDX: 0000000000000010 RSI: 0000200000000280 RDI: 000000000000000b\nRBP: 00007f47cc011e19 R08: 0000000000000000 R09: 0000000000000000\nR10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000\nR13: 00007f47cc1d6038 R14: 00007f47cc1d5fa0 R15: 00007ffc512f8aa8\n </TASK>\n\nThe buggy address belongs to the physical page:\npage: refcount:0 mapcount:0 mapping:0000000000000000 index:0xffff888036bacd00 pfn:0x36bac\nflags: 0xfff00000000000(node=0|zone=1|lastcpupid=0x7ff)\nraw: 00fff00000000000 ffffea0001243d08 ffff8880b863fdc0 0000000000000000\nraw: ffff888036bacd00 0000000000000000 00000000ffffffff 0000000000000000\npage dumped because: kasan: bad access detected\npage_owner tracks the page as freed\npage last allocated via order 2, migratetype Unmovable, gfp_mask 0x446dc0(GFP_KERNEL_ACCOUNT|__GFP_ZERO|__GFP_NOWARN|__GFP_RETRY_MAYFAIL|__GFP_COMP), pid 16741, tgid 16741 (syz-executor), ts 343313197788, free_ts 380670750466\n set_page_owner include/linux/page_owner.h:32 [inline]\n post_alloc_hook+0x240/0x2a0 mm/page_alloc.c:1851\n prep_new_page mm/page_alloc.c:1859 [inline]\n get_page_from_freelist+0x21e4/0x22c0 mm/page_alloc.c:3858\n __alloc_frozen_pages_noprof+0x181/0x370 mm/page_alloc.c:5148\n alloc_pages_mpol+0x232/0x4a0 mm/mempolicy.c:2416\n ___kmalloc_large_node+0x5f/0x1b0 mm/slub.c:4317\n __kmalloc_large_node_noprof+0x18/0x90 mm/slub.c:4348\n __do_kmalloc_node mm/slub.c:4364 [inline]\n __kvmalloc_node\n---truncated---","affected":[{"ranges":[{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"0afff91c6f5ecef27715ea71e34dc2baacba1060"},{"fixed":"233927b645cb7a14bb98d23ac72e4c7243a9f0d9"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"0afff91c6f5ecef27715ea71e34dc2baacba1060"},{"fixed":"3d3466878afd8d43ec0ca2facfbc7f03e40d0f79"}]}],"versions":["v4.18","v4.18-rc3","v4.18-rc4","v4.18-rc5","v4.18-rc6","v4.18-rc7","v4.18-rc8","v4.19","v4.19-rc1","v4.19-rc2","v4.19-rc3","v4.19-rc4","v4.19-rc5","v4.19-rc6","v4.19-rc7","v4.19-rc8","v4.20","v4.20-rc1","v4.20-rc2","v4.20-rc3","v4.20-rc4","v4.20-rc5","v4.20-rc6","v4.20-rc7","v5.0","v5.0-rc1","v5.0-rc2","v5.0-rc3","v5.0-rc4","v5.0-rc5","v5.0-rc6","v5.0-rc7","v5.0-rc8","v5.1","v5.1-rc1","v5.1-rc2","v5.1-rc3","v5.1-rc4","v5.1-rc5","v5.1-rc6","v5.1-rc7","v5.10","v5.10-rc1","v5.10-rc2","v5.10-rc3","v5.10-rc4","v5.10-rc5","v5.10-rc6","v5.10-rc7","v5.11","v5.11-rc1","v5.11-rc2","v5.11-rc3","v5.11-rc4","v5.11-rc5","v5.11-rc6","v5.11-rc7","v5.12","v5.12-rc1","v5.12-rc1-dontuse","v5.12-rc2","v5.12-rc3","v5.12-rc4","v5.12-rc5","v5.12-rc6","v5.12-rc7","v5.12-rc8","v5.13","v5.13-rc1","v5.13-rc2","v5.13-rc3","v5.13-rc4","v5.13-rc5","v5.13-rc6","v5.13-rc7","v5.14","v5.14-rc1","v5.14-rc2","v5.14-rc3","v5.14-rc4","v5.14-rc5","v5.14-rc6","v5.14-rc7","v5.15","v5.15-rc1","v5.15-rc2","v5.15-rc3","v5.15-rc4","v5.15-rc5","v5.15-rc6","v5.15-rc7","v5.16","v5.16-rc1","v5.16-rc2","v5.16-rc3","v5.16-rc4","v5.16-rc5","v5.16-rc6","v5.16-rc7","v5.16-rc8","v5.17","v5.17-rc1","v5.17-rc2","v5.17-rc3","v5.17-rc4","v5.17-rc5","v5.17-rc6","v5.17-rc7","v5.17-rc8","v5.18","v5.18-rc1","v5.18-rc2","v5.18-rc3","v5.18-rc4","v5.18-rc5","v5.18-rc6","v5.18-rc7","v5.19","v5.19-rc1","v5.19-rc2","v5.19-rc3","v5.19-rc4","v5.19-rc5","v5.19-rc6","v5.19-rc7","v5.19-rc8","v5.2","v5.2-rc1","v5.2-rc2","v5.2-rc3","v5.2-rc4","v5.2-rc5","v5.2-rc6","v5.2-rc7","v5.3","v5.3-rc1","v5.3-rc2","v5.3-rc3","v5.3-rc4","v5.3-rc5","v5.3-rc6","v5.3-rc7","v5.3-rc8","v5.4","v5.4-rc1","v5.4-rc2","v5.4-rc3","v5.4-rc4","v5.4-rc5","v5.4-rc6","v5.4-rc7","v5.4-rc8","v5.5","v5.5-rc1","v5.5-rc2","v5.5-rc3","v5.5-rc4","v5.5-rc5","v5.5-rc6","v5.5-rc7","v5.6","v5.6-rc1","v5.6-rc2","v5.6-rc3","v5.6-rc4","v5.6-rc5","v5.6-rc6","v5.6-rc7","v5.7","v5.7-rc1","v5.7-rc2","v5.7-rc3","v5.7-rc4","v5.7-rc5","v5.7-rc6","v5.7-rc7","v5.8","v5.8-rc1","v5.8-rc2","v5.8-rc3","v5.8-rc4","v5.8-rc5","v5.8-rc6","v5.8-rc7","v5.9","v5.9-rc1","v5.9-rc2","v5.9-rc3","v5.9-rc4","v5.9-rc5","v5.9-rc6","v5.9-rc7","v5.9-rc8","v6.0","v6.0-rc1","v6.0-rc2","v6.0-rc3","v6.0-rc4","v6.0-rc5","v6.0-rc6","v6.0-rc7","v6.1","v6.1-rc1","v6.1-rc2","v6.1-rc3","v6.1-rc4","v6.1-rc5","v6.1-rc6","v6.1-rc7","v6.1-rc8","v6.10","v6.10-rc1","v6.10-rc2","v6.10-rc3","v6.10-rc4","v6.10-rc5","v6.10-rc6","v6.10-rc7","v6.11","v6.11-rc1","v6.11-rc2","v6.11-rc3","v6.11-rc4","v6.11-rc5","v6.11-rc6","v6.11-rc7","v6.12","v6.12-rc1","v6.12-rc2","v6.12-rc3","v6.12-rc4","v6.12-rc5","v6.12-rc6","v6.12-rc7","v6.13","v6.13-rc1","v6.13-rc2","v6.13-rc3","v6.13-rc4","v6.13-rc5","v6.13-rc6","v6.13-rc7","v6.14","v6.14-rc1","v6.14-rc2","v6.14-rc3","v6.14-rc4","v6.14-rc5","v6.14-rc6","v6.14-rc7","v6.15","v6.15-rc1","v6.15-rc2","v6.15-rc3","v6.15-rc4","v6.15-rc5","v6.15-rc6","v6.15-rc7","v6.16","v6.16-rc1","v6.16-rc2","v6.16-rc3","v6.16-rc4","v6.16-rc5","v6.16-rc6","v6.16-rc7","v6.17","v6.17-rc1","v6.17-rc2","v6.17-rc3","v6.17-rc4","v6.17-rc5","v6.17-rc6","v6.17-rc7","v6.17.1","v6.17.2","v6.2","v6.2-rc1","v6.2-rc2","v6.2-rc3","v6.2-rc4","v6.2-rc5","v6.2-rc6","v6.2-rc7","v6.2-rc8","v6.3","v6.3-rc1","v6.3-rc2","v6.3-rc3","v6.3-rc4","v6.3-rc5","v6.3-rc6","v6.3-rc7","v6.4","v6.4-rc1","v6.4-rc2","v6.4-rc3","v6.4-rc4","v6.4-rc5","v6.4-rc6","v6.4-rc7","v6.5","v6.5-rc1","v6.5-rc2","v6.5-rc3","v6.5-rc4","v6.5-rc5","v6.5-rc6","v6.5-rc7","v6.6","v6.6-rc1","v6.6-rc2","v6.6-rc3","v6.6-rc4","v6.6-rc5","v6.6-rc6","v6.6-rc7","v6.7","v6.7-rc1","v6.7-rc2","v6.7-rc3","v6.7-rc4","v6.7-rc5","v6.7-rc6","v6.7-rc7","v6.7-rc8","v6.8","v6.8-rc1","v6.8-rc2","v6.8-rc3","v6.8-rc4","v6.8-rc5","v6.8-rc6","v6.8-rc7","v6.9","v6.9-rc1","v6.9-rc2","v6.9-rc3","v6.9-rc4","v6.9-rc5","v6.9-rc6","v6.9-rc7"],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2025-40064.json","vanir_signatures":[{"deprecated":false,"digest":{"line_hashes":["322965484062505981274792349302999183757","72816947466927444347493458005819091130","22377718605465413704768414281802601786","115957482398573049284597627788113407928","327748884565722701944704387940942531783","267841663972573328301189345187039393927","294365448467829077485827930518149604719","153184453064813557613707262714048821722","200039459511887281711843997856810853185","321192656432203446519022730511000650165","288594245806940990621061501461324766211","42375600661704486158249351608415497505","327117561701432317060571805556907418239","49781081185767591636905828365678803297","95977007250791828098027302137469437489","142649434397615490142945563354220086912","217455928720409866152947855996192506577","307529801352632254535523509636225231708","327748884565722701944704387940942531783","267356223251454383548195827870714460349","58065291814808662566069030269295360920","17116213687525169966439845776994743399","222294213339324177813410614451039437752","321192656432203446519022730511000650165","288594245806940990621061501461324766211","115427241374738454647610751604400748537","209845193489720801839426848748724059404"],"threshold":0.9},"id":"CVE-2025-40064-3587f98a","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@3d3466878afd8d43ec0ca2facfbc7f03e40d0f79","target":{"file":"net/smc/smc_pnet.c"}},{"deprecated":false,"digest":{"function_hash":"251992435601770412153599663246757525682","length":256},"id":"CVE-2025-40064-6a720ab0","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@3d3466878afd8d43ec0ca2facfbc7f03e40d0f79","target":{"file":"net/smc/smc_pnet.c","function":"smc_pnet_find_ism_resource"}},{"deprecated":false,"digest":{"function_hash":"251992435601770412153599663246757525682","length":256},"id":"CVE-2025-40064-705f0a3f","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@233927b645cb7a14bb98d23ac72e4c7243a9f0d9","target":{"file":"net/smc/smc_pnet.c","function":"smc_pnet_find_ism_resource"}},{"deprecated":false,"digest":{"line_hashes":["322965484062505981274792349302999183757","72816947466927444347493458005819091130","22377718605465413704768414281802601786","115957482398573049284597627788113407928","327748884565722701944704387940942531783","267841663972573328301189345187039393927","294365448467829077485827930518149604719","153184453064813557613707262714048821722","200039459511887281711843997856810853185","321192656432203446519022730511000650165","288594245806940990621061501461324766211","42375600661704486158249351608415497505","327117561701432317060571805556907418239","49781081185767591636905828365678803297","95977007250791828098027302137469437489","142649434397615490142945563354220086912","217455928720409866152947855996192506577","307529801352632254535523509636225231708","327748884565722701944704387940942531783","267356223251454383548195827870714460349","58065291814808662566069030269295360920","17116213687525169966439845776994743399","222294213339324177813410614451039437752","321192656432203446519022730511000650165","288594245806940990621061501461324766211","115427241374738454647610751604400748537","209845193489720801839426848748724059404"],"threshold":0.9},"id":"CVE-2025-40064-e3522659","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@233927b645cb7a14bb98d23ac72e4c7243a9f0d9","target":{"file":"net/smc/smc_pnet.c"}},{"deprecated":false,"digest":{"function_hash":"293509557907308330559984754220270517296","length":224},"id":"CVE-2025-40064-ec597051","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@233927b645cb7a14bb98d23ac72e4c7243a9f0d9","target":{"file":"net/smc/smc_pnet.c","function":"smc_pnet_find_roce_resource"}},{"deprecated":false,"digest":{"function_hash":"293509557907308330559984754220270517296","length":224},"id":"CVE-2025-40064-f76c776d","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@3d3466878afd8d43ec0ca2facfbc7f03e40d0f79","target":{"file":"net/smc/smc_pnet.c","function":"smc_pnet_find_roce_resource"}}]}},{"package":{"name":"Kernel","ecosystem":"Linux"},"ranges":[{"type":"ECOSYSTEM","events":[{"introduced":"4.19.0"},{"fixed":"6.17.3"}]}],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2025-40064.json"}}],"references":[{"type":"PACKAGE","url":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"},{"type":"WEB","url":"https://git.kernel.org/stable/c/233927b645cb7a14bb98d23ac72e4c7243a9f0d9"},{"type":"WEB","url":"https://git.kernel.org/stable/c/3d3466878afd8d43ec0ca2facfbc7f03e40d0f79"}]}