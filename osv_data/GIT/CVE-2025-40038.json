{"schema_version":"1.7.3","id":"CVE-2025-40038","published":"2025-10-28T11:48:18Z","modified":"2025-10-28T20:18:03.113699Z","summary":"KVM: SVM: Skip fastpath emulation on VM-Exit if next RIP isn't valid","details":"In the Linux kernel, the following vulnerability has been resolved:\n\nKVM: SVM: Skip fastpath emulation on VM-Exit if next RIP isn't valid\n\nSkip the WRMSR and HLT fastpaths in SVM's VM-Exit handler if the next RIP\nisn't valid, e.g. because KVM is running with nrips=false.  SVM must\ndecode and emulate to skip the instruction if the CPU doesn't provide the\nnext RIP, and getting the instruction bytes to decode requires reading\nguest memory.  Reading guest memory through the emulator can fault, i.e.\ncan sleep, which is disallowed since the fastpath handlers run with IRQs\ndisabled.\n\n BUG: sleeping function called from invalid context at ./include/linux/uaccess.h:106\n in_atomic(): 1, irqs_disabled(): 1, non_block: 0, pid: 32611, name: qemu\n preempt_count: 1, expected: 0\n INFO: lockdep is turned off.\n irq event stamp: 30580\n hardirqs last  enabled at (30579): [<ffffffffc08b2527>] vcpu_run+0x1787/0x1db0 [kvm]\n hardirqs last disabled at (30580): [<ffffffffb4f62e32>] __schedule+0x1e2/0xed0\n softirqs last  enabled at (30570): [<ffffffffb4247a64>] fpu_swap_kvm_fpstate+0x44/0x210\n softirqs last disabled at (30568): [<ffffffffb4247a64>] fpu_swap_kvm_fpstate+0x44/0x210\n CPU: 298 UID: 0 PID: 32611 Comm: qemu Tainted: G     U              6.16.0-smp--e6c618b51cfe-sleep #782 NONE\n Tainted: [U]=USER\n Hardware name: Google Astoria-Turin/astoria, BIOS 0.20241223.2-0 01/17/2025\n Call Trace:\n  <TASK>\n  dump_stack_lvl+0x7d/0xb0\n  __might_resched+0x271/0x290\n  __might_fault+0x28/0x80\n  kvm_vcpu_read_guest_page+0x8d/0xc0 [kvm]\n  kvm_fetch_guest_virt+0x92/0xc0 [kvm]\n  __do_insn_fetch_bytes+0xf3/0x1e0 [kvm]\n  x86_decode_insn+0xd1/0x1010 [kvm]\n  x86_emulate_instruction+0x105/0x810 [kvm]\n  __svm_skip_emulated_instruction+0xc4/0x140 [kvm_amd]\n  handle_fastpath_invd+0xc4/0x1a0 [kvm]\n  vcpu_run+0x11a1/0x1db0 [kvm]\n  kvm_arch_vcpu_ioctl_run+0x5cc/0x730 [kvm]\n  kvm_vcpu_ioctl+0x578/0x6a0 [kvm]\n  __se_sys_ioctl+0x6d/0xb0\n  do_syscall_64+0x8a/0x2c0\n  entry_SYSCALL_64_after_hwframe+0x4b/0x53\n RIP: 0033:0x7f479d57a94b\n  </TASK>\n\nNote, this is essentially a reapply of commit 5c30e8101e8d (\"KVM: SVM:\nSkip WRMSR fastpath on VM-Exit if next RIP isn't valid\"), but with\ndifferent justification (KVM now grabs SRCU when skipping the instruction\nfor other reasons).","affected":[{"ranges":[{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"b439eb8ab578557263815ba8581d02c1b730e348"},{"fixed":"cd3efb93677c4b0cf76348882fb429165fee33fd"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"b439eb8ab578557263815ba8581d02c1b730e348"},{"fixed":"f994e9c790ce97d3cf01af4d0a1b9add0c955aee"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"b439eb8ab578557263815ba8581d02c1b730e348"},{"fixed":"da2a3c231f7f2a5ac146d972b8c1d7d84aff6d70"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"b439eb8ab578557263815ba8581d02c1b730e348"},{"fixed":"0910dd7c9ad45a2605c45fd2bf3d1bcac087687c"}]}],"versions":["v6.10","v6.10-rc1","v6.10-rc2","v6.10-rc3","v6.10-rc4","v6.10-rc5","v6.10-rc6","v6.10-rc7","v6.11","v6.11-rc1","v6.11-rc2","v6.11-rc3","v6.11-rc4","v6.11-rc5","v6.11-rc6","v6.11-rc7","v6.12","v6.12-rc1","v6.12-rc2","v6.12-rc3","v6.12-rc4","v6.12-rc5","v6.12-rc6","v6.12-rc7","v6.12.1","v6.12.10","v6.12.11","v6.12.12","v6.12.13","v6.12.14","v6.12.15","v6.12.16","v6.12.17","v6.12.18","v6.12.19","v6.12.2","v6.12.20","v6.12.21","v6.12.22","v6.12.23","v6.12.24","v6.12.25","v6.12.26","v6.12.27","v6.12.28","v6.12.29","v6.12.3","v6.12.30","v6.12.31","v6.12.32","v6.12.33","v6.12.34","v6.12.35","v6.12.36","v6.12.37","v6.12.38","v6.12.39","v6.12.4","v6.12.40","v6.12.41","v6.12.42","v6.12.43","v6.12.44","v6.12.45","v6.12.46","v6.12.47","v6.12.48","v6.12.49","v6.12.5","v6.12.50","v6.12.51","v6.12.52","v6.12.6","v6.12.7","v6.12.8","v6.12.9","v6.13","v6.13-rc1","v6.13-rc2","v6.13-rc3","v6.13-rc4","v6.13-rc5","v6.13-rc6","v6.13-rc7","v6.14","v6.14-rc1","v6.14-rc2","v6.14-rc3","v6.14-rc4","v6.14-rc5","v6.14-rc6","v6.14-rc7","v6.15","v6.15-rc1","v6.15-rc2","v6.15-rc3","v6.15-rc4","v6.15-rc5","v6.15-rc6","v6.15-rc7","v6.16","v6.16-rc1","v6.16-rc2","v6.16-rc3","v6.16-rc4","v6.16-rc5","v6.16-rc6","v6.16-rc7","v6.17","v6.17-rc1","v6.17-rc2","v6.17-rc3","v6.17-rc4","v6.17-rc5","v6.17-rc6","v6.17-rc7","v6.17.1","v6.17.2","v6.5","v6.5-rc4","v6.5-rc5","v6.5-rc6","v6.5-rc7","v6.6","v6.6-rc1","v6.6-rc2","v6.6-rc3","v6.6-rc4","v6.6-rc5","v6.6-rc6","v6.6-rc7","v6.6.1","v6.6.10","v6.6.100","v6.6.101","v6.6.102","v6.6.103","v6.6.104","v6.6.105","v6.6.106","v6.6.107","v6.6.108","v6.6.109","v6.6.11","v6.6.110","v6.6.111","v6.6.112","v6.6.12","v6.6.13","v6.6.14","v6.6.15","v6.6.16","v6.6.17","v6.6.18","v6.6.19","v6.6.2","v6.6.20","v6.6.21","v6.6.22","v6.6.23","v6.6.24","v6.6.25","v6.6.26","v6.6.27","v6.6.28","v6.6.29","v6.6.3","v6.6.30","v6.6.31","v6.6.32","v6.6.33","v6.6.34","v6.6.35","v6.6.36","v6.6.37","v6.6.38","v6.6.39","v6.6.4","v6.6.40","v6.6.41","v6.6.42","v6.6.43","v6.6.44","v6.6.45","v6.6.46","v6.6.47","v6.6.48","v6.6.49","v6.6.5","v6.6.50","v6.6.51","v6.6.52","v6.6.53","v6.6.54","v6.6.55","v6.6.56","v6.6.57","v6.6.58","v6.6.59","v6.6.6","v6.6.60","v6.6.61","v6.6.62","v6.6.63","v6.6.64","v6.6.65","v6.6.66","v6.6.67","v6.6.68","v6.6.69","v6.6.7","v6.6.70","v6.6.71","v6.6.72","v6.6.73","v6.6.74","v6.6.75","v6.6.76","v6.6.77","v6.6.78","v6.6.79","v6.6.8","v6.6.80","v6.6.81","v6.6.82","v6.6.83","v6.6.84","v6.6.85","v6.6.86","v6.6.87","v6.6.88","v6.6.89","v6.6.9","v6.6.90","v6.6.91","v6.6.92","v6.6.93","v6.6.94","v6.6.95","v6.6.96","v6.6.97","v6.6.98","v6.6.99","v6.7","v6.7-rc1","v6.7-rc2","v6.7-rc3","v6.7-rc4","v6.7-rc5","v6.7-rc6","v6.7-rc7","v6.7-rc8","v6.8","v6.8-rc1","v6.8-rc2","v6.8-rc3","v6.8-rc4","v6.8-rc5","v6.8-rc6","v6.8-rc7","v6.9","v6.9-rc1","v6.9-rc2","v6.9-rc3","v6.9-rc4","v6.9-rc5","v6.9-rc6","v6.9-rc7"],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2025-40038.json","vanir_signatures":[{"deprecated":false,"digest":{"line_hashes":["309435638016002424742650247759756489681","131437683790884221065469662866203043301","6563069656097061952379870916246148830","275338463583377349078495664504580739675","320300323316197110787872927949255244175","165455744169027919780782443557885497207","102376914128392582091319433313959541720","60877654392011071709389803586168792934","140956383371528659899095909438639169597"],"threshold":0.9},"id":"CVE-2025-40038-27b0caf0","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@f994e9c790ce97d3cf01af4d0a1b9add0c955aee","target":{"file":"arch/x86/kvm/svm/svm.c"}},{"deprecated":false,"digest":{"line_hashes":["147995454351485416050423246859287735148","292734134008927119910066445849561149890","285063580769220821580293784721431435823","18617468577552981349608527230461599144","229702789898739366607929194747959549670","285584720573405118036228100266418980261","94866961531850448369958526796284966652","255736074800776475135566902578533336370"],"threshold":0.9},"id":"CVE-2025-40038-38756dbb","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@cd3efb93677c4b0cf76348882fb429165fee33fd","target":{"file":"arch/x86/kvm/svm/svm.c"}},{"deprecated":false,"digest":{"function_hash":"248901709073597471041963798955773368556","length":281},"id":"CVE-2025-40038-43dff5cc","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@cd3efb93677c4b0cf76348882fb429165fee33fd","target":{"file":"arch/x86/kvm/svm/svm.c","function":"svm_exit_handlers_fastpath"}},{"deprecated":false,"digest":{"function_hash":"289617122205725403703278654493324542857","length":378},"id":"CVE-2025-40038-5cc3ee06","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@da2a3c231f7f2a5ac146d972b8c1d7d84aff6d70","target":{"file":"arch/x86/kvm/svm/svm.c","function":"svm_exit_handlers_fastpath"}},{"deprecated":false,"digest":{"line_hashes":["309435638016002424742650247759756489681","131437683790884221065469662866203043301","6563069656097061952379870916246148830","275338463583377349078495664504580739675","320300323316197110787872927949255244175","165455744169027919780782443557885497207","102376914128392582091319433313959541720","60877654392011071709389803586168792934","140956383371528659899095909438639169597"],"threshold":0.9},"id":"CVE-2025-40038-6298759e","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@da2a3c231f7f2a5ac146d972b8c1d7d84aff6d70","target":{"file":"arch/x86/kvm/svm/svm.c"}},{"deprecated":false,"digest":{"function_hash":"289617122205725403703278654493324542857","length":378},"id":"CVE-2025-40038-70bc2e47","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@f994e9c790ce97d3cf01af4d0a1b9add0c955aee","target":{"file":"arch/x86/kvm/svm/svm.c","function":"svm_exit_handlers_fastpath"}},{"deprecated":false,"digest":{"line_hashes":["309435638016002424742650247759756489681","131437683790884221065469662866203043301","6563069656097061952379870916246148830","275338463583377349078495664504580739675","320300323316197110787872927949255244175","165455744169027919780782443557885497207","102376914128392582091319433313959541720","60877654392011071709389803586168792934","140956383371528659899095909438639169597"],"threshold":0.9},"id":"CVE-2025-40038-c385fcd1","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@0910dd7c9ad45a2605c45fd2bf3d1bcac087687c","target":{"file":"arch/x86/kvm/svm/svm.c"}},{"deprecated":false,"digest":{"function_hash":"289617122205725403703278654493324542857","length":378},"id":"CVE-2025-40038-cfefa476","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@0910dd7c9ad45a2605c45fd2bf3d1bcac087687c","target":{"file":"arch/x86/kvm/svm/svm.c","function":"svm_exit_handlers_fastpath"}}]}},{"package":{"name":"Kernel","ecosystem":"Linux"},"ranges":[{"type":"ECOSYSTEM","events":[{"introduced":"6.5.0"},{"fixed":"6.6.113"}]},{"type":"ECOSYSTEM","events":[{"introduced":"6.7.0"},{"fixed":"6.12.53"}]},{"type":"ECOSYSTEM","events":[{"introduced":"6.13.0"},{"fixed":"6.17.3"}]}],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2025-40038.json"}}],"references":[{"type":"PACKAGE","url":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"},{"type":"WEB","url":"https://git.kernel.org/stable/c/0910dd7c9ad45a2605c45fd2bf3d1bcac087687c"},{"type":"WEB","url":"https://git.kernel.org/stable/c/cd3efb93677c4b0cf76348882fb429165fee33fd"},{"type":"WEB","url":"https://git.kernel.org/stable/c/da2a3c231f7f2a5ac146d972b8c1d7d84aff6d70"},{"type":"WEB","url":"https://git.kernel.org/stable/c/f994e9c790ce97d3cf01af4d0a1b9add0c955aee"}]}