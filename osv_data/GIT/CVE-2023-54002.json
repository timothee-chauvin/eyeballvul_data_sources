{"schema_version":"1.7.3","id":"CVE-2023-54002","published":"2025-12-24T10:55:37.699Z","modified":"2026-01-05T21:12:51.807302Z","summary":"btrfs: fix assertion of exclop condition when starting balance","details":"In the Linux kernel, the following vulnerability has been resolved:\n\nbtrfs: fix assertion of exclop condition when starting balance\n\nBalance as exclusive state is compatible with paused balance and device\nadd, which makes some things more complicated. The assertion of valid\nstates when starting from paused balance needs to take into account two\nmore states, the combinations can be hit when there are several threads\nracing to start balance and device add. This won't typically happen when\nthe commands are started from command line.\n\nScenario 1: With exclusive_operation state == BTRFS_EXCLOP_NONE.\n\nConcurrently adding multiple devices to the same mount point and\nbtrfs_exclop_finish executed finishes before assertion in\nbtrfs_exclop_balance, exclusive_operation will changed to\nBTRFS_EXCLOP_NONE state which lead to assertion failed:\n\n  fs_info->exclusive_operation == BTRFS_EXCLOP_BALANCE ||\n  fs_info->exclusive_operation == BTRFS_EXCLOP_DEV_ADD,\n  in fs/btrfs/ioctl.c:456\n  Call Trace:\n   <TASK>\n   btrfs_exclop_balance+0x13c/0x310\n   ? memdup_user+0xab/0xc0\n   ? PTR_ERR+0x17/0x20\n   btrfs_ioctl_add_dev+0x2ee/0x320\n   btrfs_ioctl+0x9d5/0x10d0\n   ? btrfs_ioctl_encoded_write+0xb80/0xb80\n   __x64_sys_ioctl+0x197/0x210\n   do_syscall_64+0x3c/0xb0\n   entry_SYSCALL_64_after_hwframe+0x63/0xcd\n\nScenario 2: With exclusive_operation state == BTRFS_EXCLOP_BALANCE_PAUSED.\n\nConcurrently adding multiple devices to the same mount point and\nbtrfs_exclop_balance executed finish before the latter thread execute\nassertion in btrfs_exclop_balance, exclusive_operation will changed to\nBTRFS_EXCLOP_BALANCE_PAUSED state which lead to assertion failed:\n\n  fs_info->exclusive_operation == BTRFS_EXCLOP_BALANCE ||\n  fs_info->exclusive_operation == BTRFS_EXCLOP_DEV_ADD ||\n  fs_info->exclusive_operation == BTRFS_EXCLOP_NONE,\n  fs/btrfs/ioctl.c:458\n  Call Trace:\n   <TASK>\n   btrfs_exclop_balance+0x240/0x410\n   ? memdup_user+0xab/0xc0\n   ? PTR_ERR+0x17/0x20\n   btrfs_ioctl_add_dev+0x2ee/0x320\n   btrfs_ioctl+0x9d5/0x10d0\n   ? btrfs_ioctl_encoded_write+0xb80/0xb80\n   __x64_sys_ioctl+0x197/0x210\n   do_syscall_64+0x3c/0xb0\n   entry_SYSCALL_64_after_hwframe+0x63/0xcd\n\nAn example of the failed assertion is below, which shows that the\npaused balance is also needed to be checked.\n\n  root@syzkaller:/home/xsk# ./repro\n  Failed to add device /dev/vda, errno 14\n  Failed to add device /dev/vda, errno 14\n  Failed to add device /dev/vda, errno 14\n  Failed to add device /dev/vda, errno 14\n  Failed to add device /dev/vda, errno 14\n  Failed to add device /dev/vda, errno 14\n  Failed to add device /dev/vda, errno 14\n  Failed to add device /dev/vda, errno 14\n  Failed to add device /dev/vda, errno 14\n  [  416.611428][ T7970] BTRFS info (device loop0): fs_info exclusive_operation: 0\n  Failed to add device /dev/vda, errno 14\n  [  416.613973][ T7971] BTRFS info (device loop0): fs_info exclusive_operation: 3\n  Failed to add device /dev/vda, errno 14\n  [  416.615456][ T7972] BTRFS info (device loop0): fs_info exclusive_operation: 3\n  Failed to add device /dev/vda, errno 14\n  [  416.617528][ T7973] BTRFS info (device loop0): fs_info exclusive_operation: 3\n  Failed to add device /dev/vda, errno 14\n  [  416.618359][ T7974] BTRFS info (device loop0): fs_info exclusive_operation: 3\n  Failed to add device /dev/vda, errno 14\n  [  416.622589][ T7975] BTRFS info (device loop0): fs_info exclusive_operation: 3\n  Failed to add device /dev/vda, errno 14\n  [  416.624034][ T7976] BTRFS info (device loop0): fs_info exclusive_operation: 3\n  Failed to add device /dev/vda, errno 14\n  [  416.626420][ T7977] BTRFS info (device loop0): fs_info exclusive_operation: 3\n  Failed to add device /dev/vda, errno 14\n  [  416.627643][ T7978] BTRFS info (device loop0): fs_info exclusive_operation: 3\n  Failed to add device /dev/vda, errno 14\n  [  416.629006][ T7979] BTRFS info (device loop0): fs_info exclusive_operation: 3\n  [  416.630298][ T7980] BTRFS info (device loop0): fs_info exclusive_operation: 3\n  Fai\n---truncated---","affected":[{"ranges":[{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"a174c0a2e857081195db6888323802f0fae793ef"},{"fixed":"17eaeee4c5f24946aad0298d51f32981c3161d13"},{"fixed":"7877dc1136ada770622d22041be306539902951b"},{"fixed":"6062e9e335a3bf409b5118bfe4cc10aff4b6adb1"},{"fixed":"ac868bc9d136cde6e3eb5de77019a63d57a540ff"}]}],"versions":["v5.16","v5.17","v5.17-rc1","v5.17-rc2","v5.17-rc3","v5.17-rc4","v5.17-rc5","v5.17-rc6","v5.17-rc7","v5.17-rc8","v5.18","v5.18-rc1","v5.18-rc2","v5.18-rc3","v5.18-rc4","v5.18-rc5","v5.18-rc6","v5.18-rc7","v5.19","v5.19-rc1","v5.19-rc2","v5.19-rc3","v5.19-rc4","v5.19-rc5","v5.19-rc6","v5.19-rc7","v5.19-rc8","v6.0","v6.0-rc1","v6.0-rc2","v6.0-rc3","v6.0-rc4","v6.0-rc5","v6.0-rc6","v6.0-rc7","v6.1","v6.1-rc1","v6.1-rc2","v6.1-rc3","v6.1-rc4","v6.1-rc5","v6.1-rc6","v6.1-rc7","v6.1-rc8","v6.1.1","v6.1.10","v6.1.11","v6.1.12","v6.1.13","v6.1.14","v6.1.15","v6.1.16","v6.1.17","v6.1.18","v6.1.19","v6.1.2","v6.1.20","v6.1.21","v6.1.22","v6.1.23","v6.1.24","v6.1.25","v6.1.26","v6.1.27","v6.1.28","v6.1.3","v6.1.4","v6.1.5","v6.1.6","v6.1.7","v6.1.8","v6.1.9","v6.2","v6.2-rc1","v6.2-rc2","v6.2-rc3","v6.2-rc4","v6.2-rc5","v6.2-rc6","v6.2-rc7","v6.2-rc8","v6.2.1","v6.2.10","v6.2.11","v6.2.12","v6.2.13","v6.2.14","v6.2.15","v6.2.2","v6.2.3","v6.2.4","v6.2.5","v6.2.6","v6.2.7","v6.2.8","v6.2.9","v6.3","v6.3-rc1","v6.3-rc2","v6.3-rc3","v6.3-rc4","v6.3-rc5","v6.3-rc6","v6.3-rc7","v6.3.1","v6.3.2"],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2023-54002.json"}},{"package":{"name":"Kernel","ecosystem":"Linux"},"ranges":[{"type":"ECOSYSTEM","events":[{"introduced":"5.17.0"},{"fixed":"6.1.29"}]},{"type":"ECOSYSTEM","events":[{"introduced":"6.2.0"},{"fixed":"6.2.16"}]},{"type":"ECOSYSTEM","events":[{"introduced":"6.3.0"},{"fixed":"6.3.3"}]}],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2023-54002.json"}}],"references":[{"type":"PACKAGE","url":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"},{"type":"WEB","url":"https://git.kernel.org/stable/c/17eaeee4c5f24946aad0298d51f32981c3161d13"},{"type":"WEB","url":"https://git.kernel.org/stable/c/6062e9e335a3bf409b5118bfe4cc10aff4b6adb1"},{"type":"WEB","url":"https://git.kernel.org/stable/c/7877dc1136ada770622d22041be306539902951b"},{"type":"WEB","url":"https://git.kernel.org/stable/c/ac868bc9d136cde6e3eb5de77019a63d57a540ff"},{"type":"ADVISORY","url":"https://github.com/CVEProject/cvelistV5/tree/main/cves/2023/54xxx/CVE-2023-54002.json"},{"type":"ADVISORY","url":"https://nvd.nist.gov/vuln/detail/CVE-2023-54002"}],"database_specific":{"cna_assigner":"Linux","osv_generated_from":"https://github.com/CVEProject/cvelistV5/tree/main/cves/2023/54xxx/CVE-2023-54002.json"}}