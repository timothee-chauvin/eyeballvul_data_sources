{"schema_version":"1.7.3","id":"CVE-2022-49943","published":"2025-06-18T10:59:58Z","modified":"2025-10-21T07:59:10.781069Z","related":["SUSE-SU-2025:02264-1"],"summary":"USB: gadget: Fix obscure lockdep violation for udc_mutex","details":"In the Linux kernel, the following vulnerability has been resolved:\n\nUSB: gadget: Fix obscure lockdep violation for udc_mutex\n\nA recent commit expanding the scope of the udc_lock mutex in the\ngadget core managed to cause an obscure and slightly bizarre lockdep\nviolation.  In abbreviated form:\n\n======================================================\nWARNING: possible circular locking dependency detected\n5.19.0-rc7+ #12510 Not tainted\n------------------------------------------------------\nudevadm/312 is trying to acquire lock:\nffff80000aae1058 (udc_lock){+.+.}-{3:3}, at: usb_udc_uevent+0x54/0xe0\n\nbut task is already holding lock:\nffff000002277548 (kn->active#4){++++}-{0:0}, at: kernfs_seq_start+0x34/0xe0\n\nwhich lock already depends on the new lock.\n\nthe existing dependency chain (in reverse order) is:\n\n-> #3 (kn->active#4){++++}-{0:0}:\n        lock_acquire+0x68/0x84\n        __kernfs_remove+0x268/0x380\n        kernfs_remove_by_name_ns+0x58/0xac\n        sysfs_remove_file_ns+0x18/0x24\n        device_del+0x15c/0x440\n\n-> #2 (device_links_lock){+.+.}-{3:3}:\n        lock_acquire+0x68/0x84\n        __mutex_lock+0x9c/0x430\n        mutex_lock_nested+0x38/0x64\n        device_link_remove+0x3c/0xa0\n        _regulator_put.part.0+0x168/0x190\n        regulator_put+0x3c/0x54\n        devm_regulator_release+0x14/0x20\n\n-> #1 (regulator_list_mutex){+.+.}-{3:3}:\n        lock_acquire+0x68/0x84\n        __mutex_lock+0x9c/0x430\n        mutex_lock_nested+0x38/0x64\n        regulator_lock_dependent+0x54/0x284\n        regulator_enable+0x34/0x80\n        phy_power_on+0x24/0x130\n        __dwc2_lowlevel_hw_enable+0x100/0x130\n        dwc2_lowlevel_hw_enable+0x18/0x40\n        dwc2_hsotg_udc_start+0x6c/0x2f0\n        gadget_bind_driver+0x124/0x1f4\n\n-> #0 (udc_lock){+.+.}-{3:3}:\n        __lock_acquire+0x1298/0x20cc\n        lock_acquire.part.0+0xe0/0x230\n        lock_acquire+0x68/0x84\n        __mutex_lock+0x9c/0x430\n        mutex_lock_nested+0x38/0x64\n        usb_udc_uevent+0x54/0xe0\n\nEvidently this was caused by the scope of udc_mutex being too large.\nThe mutex is only meant to protect udc->driver along with a few other\nthings.  As far as I can tell, there's no reason for the mutex to be\nheld while the gadget core calls a gadget driver's ->bind or ->unbind\nroutine, or while a UDC is being started or stopped.  (This accounts\nfor link #1 in the chain above, where the mutex is held while the\ndwc2_hsotg_udc is started as part of driver probing.)\n\nGadget drivers' ->disconnect callbacks are problematic.  Even though\nusb_gadget_disconnect() will now acquire the udc_mutex, there's a\nwindow in usb_gadget_bind_driver() between the times when the mutex is\nreleased and the ->bind callback is invoked.  If a disconnect occurred\nduring that window, we could call the driver's ->disconnect routine\nbefore its ->bind routine.  To prevent this from happening, it will be\nnecessary to prevent a UDC from connecting while it has no gadget\ndriver.  This should be done already but it doesn't seem to be;\ncurrently usb_gadget_connect() has no check for this.  Such a check\nwill have to be added later.\n\nSome degree of mutual exclusion is required in soft_connect_store(),\nwhich can dereference udc->driver at arbitrary times since it is a\nsysfs callback.  The solution here is to acquire the gadget's device\nlock rather than the udc_mutex.  Since the driver core guarantees that\nthe device lock is always held during driver binding and unbinding,\nthis will make the accesses in soft_connect_store() mutually exclusive\nwith any changes to udc->driver.\n\nLastly, it turns out there is one place which should hold the\nudc_mutex but currently does not: The function_show() routine needs\nprotection while it dereferences udc->driver.  The missing lock and\nunlock calls are added.","affected":[{"ranges":[{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"f44b0b95d50fffeca036e1ba36770390e0b519dd"},{"fixed":"1a065e4673cbdd9f222a05f85e17d78ea50c8d9c"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"2191c00855b03aa59c20e698be713d952d51fc18"},{"fixed":"1016fc0c096c92dd0e6e0541daac7a7868169903"}]}],"versions":["v5.19","v5.19-rc8","v5.19.7","v6.0-rc1"],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2022-49943.json","vanir_signatures":[{"deprecated":false,"digest":{"function_hash":"231971528913074479858380331667069581566","length":1067},"id":"CVE-2022-49943-039ba69c","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1016fc0c096c92dd0e6e0541daac7a7868169903","target":{"file":"drivers/usb/gadget/udc/core.c","function":"gadget_bind_driver"}},{"deprecated":false,"digest":{"function_hash":"5933765967962957163467563917560081040","length":496},"id":"CVE-2022-49943-25d910d2","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1016fc0c096c92dd0e6e0541daac7a7868169903","target":{"file":"drivers/usb/gadget/udc/core.c","function":"gadget_unbind_driver"}},{"deprecated":false,"digest":{"function_hash":"212828007181446757112106723090610634481","length":413},"id":"CVE-2022-49943-4da639c3","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1a065e4673cbdd9f222a05f85e17d78ea50c8d9c","target":{"file":"drivers/usb/gadget/udc/core.c","function":"usb_gadget_disconnect"}},{"deprecated":false,"digest":{"function_hash":"172534825515399158219986663676512661747","length":673},"id":"CVE-2022-49943-5a93f33a","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1016fc0c096c92dd0e6e0541daac7a7868169903","target":{"file":"drivers/usb/gadget/udc/core.c","function":"soft_connect_store"}},{"deprecated":false,"digest":{"function_hash":"172534825515399158219986663676512661747","length":673},"id":"CVE-2022-49943-5e234e83","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1a065e4673cbdd9f222a05f85e17d78ea50c8d9c","target":{"file":"drivers/usb/gadget/udc/core.c","function":"soft_connect_store"}},{"deprecated":false,"digest":{"line_hashes":["202326241014119482740581741190749918045","291010649055762150234566558010801234266","117018234814890792775173567803219424665","24201021360554540620654968623824289855","5567766108673988956167229905979715671","590909098577891843029787867673654297","146036326558416914469755746765283320123","303202152574949886794478264420318237771","204310276783473255780868507827355779930","301016282524084944420777934355479841000","167931702083756401701700856535524667235","140737803800016992921070991235574757423","321512206912557183267110759630707710055","64857237098815498464991079884362294149","219133021071034122275180595777943515607","66993295874374824097667778448076995102","189077803989961072914751291531212771404","190895835332712281166300413168469343509","41130818646522991659683684312034564109","128182146683945684325571191584945072791","245323870138450126110368764128491315757","274238355165208210733920645025611561788","268758784528112231433005715234695572197","284018990293523298617968373196193846329","232746265730712901408736432937733104964","199606627155550823652706575604232853507","12243089948658080714293268306152932186","241361052453226312555757605533915139676","128604835505542183418172741174268159567","61007850932047392150807802926652341604","292749499288108121550757277755977242519","224561425000140492906167000622811591037","337799021193348335528545809729836309329","319109301729973951440916267404740993659","206822984941690785458290667220242823965","78237217448895929792601839673628673848","204822562189063169516251680121602889961"],"threshold":0.9},"id":"CVE-2022-49943-87ce8c90","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1a065e4673cbdd9f222a05f85e17d78ea50c8d9c","target":{"file":"drivers/usb/gadget/udc/core.c"}},{"deprecated":false,"digest":{"function_hash":"5933765967962957163467563917560081040","length":496},"id":"CVE-2022-49943-8db5f107","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1a065e4673cbdd9f222a05f85e17d78ea50c8d9c","target":{"file":"drivers/usb/gadget/udc/core.c","function":"gadget_unbind_driver"}},{"deprecated":false,"digest":{"function_hash":"231971528913074479858380331667069581566","length":1067},"id":"CVE-2022-49943-9681425f","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1a065e4673cbdd9f222a05f85e17d78ea50c8d9c","target":{"file":"drivers/usb/gadget/udc/core.c","function":"gadget_bind_driver"}},{"deprecated":false,"digest":{"function_hash":"212828007181446757112106723090610634481","length":413},"id":"CVE-2022-49943-9d4253b4","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1016fc0c096c92dd0e6e0541daac7a7868169903","target":{"file":"drivers/usb/gadget/udc/core.c","function":"usb_gadget_disconnect"}},{"deprecated":false,"digest":{"line_hashes":["202326241014119482740581741190749918045","291010649055762150234566558010801234266","117018234814890792775173567803219424665","24201021360554540620654968623824289855","5567766108673988956167229905979715671","590909098577891843029787867673654297","146036326558416914469755746765283320123","303202152574949886794478264420318237771","204310276783473255780868507827355779930","301016282524084944420777934355479841000","167931702083756401701700856535524667235","140737803800016992921070991235574757423","321512206912557183267110759630707710055","64857237098815498464991079884362294149","219133021071034122275180595777943515607","66993295874374824097667778448076995102","189077803989961072914751291531212771404","190895835332712281166300413168469343509","41130818646522991659683684312034564109","128182146683945684325571191584945072791","245323870138450126110368764128491315757","274238355165208210733920645025611561788","268758784528112231433005715234695572197","284018990293523298617968373196193846329","232746265730712901408736432937733104964","199606627155550823652706575604232853507","12243089948658080714293268306152932186","241361052453226312555757605533915139676","128604835505542183418172741174268159567","61007850932047392150807802926652341604","292749499288108121550757277755977242519","224561425000140492906167000622811591037","337799021193348335528545809729836309329","319109301729973951440916267404740993659","206822984941690785458290667220242823965","78237217448895929792601839673628673848","204822562189063169516251680121602889961"],"threshold":0.9},"id":"CVE-2022-49943-ad0a5b53","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1016fc0c096c92dd0e6e0541daac7a7868169903","target":{"file":"drivers/usb/gadget/udc/core.c"}},{"deprecated":false,"digest":{"function_hash":"101079313309565193195138506974326238576","length":290},"id":"CVE-2022-49943-c56d0354","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1016fc0c096c92dd0e6e0541daac7a7868169903","target":{"file":"drivers/usb/gadget/udc/core.c","function":"function_show"}},{"deprecated":false,"digest":{"function_hash":"101079313309565193195138506974326238576","length":290},"id":"CVE-2022-49943-c730480b","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1a065e4673cbdd9f222a05f85e17d78ea50c8d9c","target":{"file":"drivers/usb/gadget/udc/core.c","function":"function_show"}}]}},{"package":{"name":"Kernel","ecosystem":"Linux"},"ranges":[{"type":"ECOSYSTEM","events":[{"introduced":"5.19.7"},{"fixed":"5.19.8"}]}],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2022-49943.json"}}],"references":[{"type":"PACKAGE","url":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"},{"type":"WEB","url":"https://git.kernel.org/stable/c/1016fc0c096c92dd0e6e0541daac7a7868169903"},{"type":"WEB","url":"https://git.kernel.org/stable/c/1a065e4673cbdd9f222a05f85e17d78ea50c8d9c"}]}