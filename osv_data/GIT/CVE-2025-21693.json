{"schema_version":"1.7.3","id":"CVE-2025-21693","published":"2025-02-10T15:58:49.056Z","modified":"2025-11-20T07:54:11.973846Z","related":["SUSE-SU-2025:01919-1","SUSE-SU-2025:01967-1","SUSE-SU-2025:1176-1","SUSE-SU-2025:1177-1","SUSE-SU-2025:1178-1","SUSE-SU-2025:1180-1","SUSE-SU-2025:1183-1","SUSE-SU-2025:1195-1","SUSE-SU-2025:1241-1"],"summary":"mm: zswap: properly synchronize freeing resources during CPU hotunplug","details":"In the Linux kernel, the following vulnerability has been resolved:\n\nmm: zswap: properly synchronize freeing resources during CPU hotunplug\n\nIn zswap_compress() and zswap_decompress(), the per-CPU acomp_ctx of the\ncurrent CPU at the beginning of the operation is retrieved and used\nthroughout.  However, since neither preemption nor migration are disabled,\nit is possible that the operation continues on a different CPU.\n\nIf the original CPU is hotunplugged while the acomp_ctx is still in use,\nwe run into a UAF bug as some of the resources attached to the acomp_ctx\nare freed during hotunplug in zswap_cpu_comp_dead() (i.e. \nacomp_ctx.buffer, acomp_ctx.req, or acomp_ctx.acomp).\n\nThe problem was introduced in commit 1ec3b5fe6eec (\"mm/zswap: move to use\ncrypto_acomp API for hardware acceleration\") when the switch to the\ncrypto_acomp API was made.  Prior to that, the per-CPU crypto_comp was\nretrieved using get_cpu_ptr() which disables preemption and makes sure the\nCPU cannot go away from under us.  Preemption cannot be disabled with the\ncrypto_acomp API as a sleepable context is needed.\n\nUse the acomp_ctx.mutex to synchronize CPU hotplug callbacks allocating\nand freeing resources with compression/decompression paths.  Make sure\nthat acomp_ctx.req is NULL when the resources are freed.  In the\ncompression/decompression paths, check if acomp_ctx.req is NULL after\nacquiring the mutex (meaning the CPU was offlined) and retry on the new\nCPU.\n\nThe initialization of acomp_ctx.mutex is moved from the CPU hotplug\ncallback to the pool initialization where it belongs (where the mutex is\nallocated).  In addition to adding clarity, this makes sure that CPU\nhotplug cannot reinitialize a mutex that is already locked by\ncompression/decompression.\n\nPreviously a fix was attempted by holding cpus_read_lock() [1].  This\nwould have caused a potential deadlock as it is possible for code already\nholding the lock to fall into reclaim and enter zswap (causing a\ndeadlock).  A fix was also attempted using SRCU for synchronization, but\nJohannes pointed out that synchronize_srcu() cannot be used in CPU hotplug\nnotifiers [2].\n\nAlternative fixes that were considered/attempted and could have worked:\n- Refcounting the per-CPU acomp_ctx. This involves complexity in\n  handling the race between the refcount dropping to zero in\n  zswap_[de]compress() and the refcount being re-initialized when the\n  CPU is onlined.\n- Disabling migration before getting the per-CPU acomp_ctx [3], but\n  that's discouraged and is a much bigger hammer than needed, and could\n  result in subtle performance issues.\n\n[1]https://lkml.kernel.org/20241219212437.2714151-1-yosryahmed@google.com/\n[2]https://lkml.kernel.org/20250107074724.1756696-2-yosryahmed@google.com/\n[3]https://lkml.kernel.org/20250107222236.2715883-2-yosryahmed@google.com/\n\n[yosryahmed@google.com: remove comment]","affected":[{"ranges":[{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"1ec3b5fe6eec782f4e5e0a80e4ce1909ffd5d161"},{"fixed":"8d29ff5d50304daa41dc3cfdda4a9d1e46cf5be1"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"1ec3b5fe6eec782f4e5e0a80e4ce1909ffd5d161"},{"fixed":"12dcb0ef540629a281533f9dedc1b6b8e14cfb65"}]}],"versions":["v5.11","v5.11-rc1","v5.11-rc2","v5.11-rc3","v5.11-rc4","v5.11-rc5","v5.11-rc6","v5.11-rc7","v5.12","v5.12-rc1","v5.12-rc1-dontuse","v5.12-rc2","v5.12-rc3","v5.12-rc4","v5.12-rc5","v5.12-rc6","v5.12-rc7","v5.12-rc8","v5.13","v5.13-rc1","v5.13-rc2","v5.13-rc3","v5.13-rc4","v5.13-rc5","v5.13-rc6","v5.13-rc7","v5.14","v5.14-rc1","v5.14-rc2","v5.14-rc3","v5.14-rc4","v5.14-rc5","v5.14-rc6","v5.14-rc7","v5.15","v5.15-rc1","v5.15-rc2","v5.15-rc3","v5.15-rc4","v5.15-rc5","v5.15-rc6","v5.15-rc7","v5.16","v5.16-rc1","v5.16-rc2","v5.16-rc3","v5.16-rc4","v5.16-rc5","v5.16-rc6","v5.16-rc7","v5.16-rc8","v5.17","v5.17-rc1","v5.17-rc2","v5.17-rc3","v5.17-rc4","v5.17-rc5","v5.17-rc6","v5.17-rc7","v5.17-rc8","v5.18","v5.18-rc1","v5.18-rc2","v5.18-rc3","v5.18-rc4","v5.18-rc5","v5.18-rc6","v5.18-rc7","v5.19","v5.19-rc1","v5.19-rc2","v5.19-rc3","v5.19-rc4","v5.19-rc5","v5.19-rc6","v5.19-rc7","v5.19-rc8","v6.0","v6.0-rc1","v6.0-rc2","v6.0-rc3","v6.0-rc4","v6.0-rc5","v6.0-rc6","v6.0-rc7","v6.1","v6.1-rc1","v6.1-rc2","v6.1-rc3","v6.1-rc4","v6.1-rc5","v6.1-rc6","v6.1-rc7","v6.1-rc8","v6.10","v6.10-rc1","v6.10-rc2","v6.10-rc3","v6.10-rc4","v6.10-rc5","v6.10-rc6","v6.10-rc7","v6.11","v6.11-rc1","v6.11-rc2","v6.11-rc3","v6.11-rc4","v6.11-rc5","v6.11-rc6","v6.11-rc7","v6.12","v6.12-rc1","v6.12-rc2","v6.12-rc3","v6.12-rc4","v6.12-rc5","v6.12-rc6","v6.12-rc7","v6.12.1","v6.12.10","v6.12.11","v6.12.2","v6.12.3","v6.12.4","v6.12.5","v6.12.6","v6.12.7","v6.12.8","v6.12.9","v6.13-rc1","v6.13-rc2","v6.13-rc3","v6.13-rc4","v6.13-rc5","v6.13-rc6","v6.2","v6.2-rc1","v6.2-rc2","v6.2-rc3","v6.2-rc4","v6.2-rc5","v6.2-rc6","v6.2-rc7","v6.2-rc8","v6.3","v6.3-rc1","v6.3-rc2","v6.3-rc3","v6.3-rc4","v6.3-rc5","v6.3-rc6","v6.3-rc7","v6.4","v6.4-rc1","v6.4-rc2","v6.4-rc3","v6.4-rc4","v6.4-rc5","v6.4-rc6","v6.4-rc7","v6.5","v6.5-rc1","v6.5-rc2","v6.5-rc3","v6.5-rc4","v6.5-rc5","v6.5-rc6","v6.5-rc7","v6.6","v6.6-rc1","v6.6-rc2","v6.6-rc3","v6.6-rc4","v6.6-rc5","v6.6-rc6","v6.6-rc7","v6.7","v6.7-rc1","v6.7-rc2","v6.7-rc3","v6.7-rc4","v6.7-rc5","v6.7-rc6","v6.7-rc7","v6.7-rc8","v6.8","v6.8-rc1","v6.8-rc2","v6.8-rc3","v6.8-rc4","v6.8-rc5","v6.8-rc6","v6.8-rc7","v6.9","v6.9-rc1","v6.9-rc2","v6.9-rc3","v6.9-rc4","v6.9-rc5","v6.9-rc6","v6.9-rc7"],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2025-21693.json","vanir_signatures":[{"deprecated":false,"digest":{"function_hash":"335428537082428937725684698684029240882","length":1070},"id":"CVE-2025-21693-0f703e45","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@12dcb0ef540629a281533f9dedc1b6b8e14cfb65","target":{"file":"mm/zswap.c","function":"zswap_cpu_comp_prepare"}},{"deprecated":false,"digest":{"function_hash":"211920682167081380513445883596754476632","length":1371},"id":"CVE-2025-21693-12a45d43","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@12dcb0ef540629a281533f9dedc1b6b8e14cfb65","target":{"file":"mm/zswap.c","function":"zswap_pool_create"}},{"deprecated":false,"digest":{"function_hash":"237739074751041022295754892397569528455","length":859},"id":"CVE-2025-21693-4aed0539","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@12dcb0ef540629a281533f9dedc1b6b8e14cfb65","target":{"file":"mm/zswap.c","function":"zswap_decompress"}},{"deprecated":false,"digest":{"function_hash":"335428537082428937725684698684029240882","length":1070},"id":"CVE-2025-21693-54aa88b0","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@8d29ff5d50304daa41dc3cfdda4a9d1e46cf5be1","target":{"file":"mm/zswap.c","function":"zswap_cpu_comp_prepare"}},{"deprecated":false,"digest":{"function_hash":"8802529217545175856705918319206230108","length":386},"id":"CVE-2025-21693-5f691123","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@12dcb0ef540629a281533f9dedc1b6b8e14cfb65","target":{"file":"mm/zswap.c","function":"zswap_cpu_comp_dead"}},{"deprecated":false,"digest":{"function_hash":"237739074751041022295754892397569528455","length":859},"id":"CVE-2025-21693-84c1b803","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@8d29ff5d50304daa41dc3cfdda4a9d1e46cf5be1","target":{"file":"mm/zswap.c","function":"zswap_decompress"}},{"deprecated":false,"digest":{"function_hash":"243864002951823973148531085146190129196","length":1208},"id":"CVE-2025-21693-9b6a1333","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@12dcb0ef540629a281533f9dedc1b6b8e14cfb65","target":{"file":"mm/zswap.c","function":"zswap_compress"}},{"deprecated":false,"digest":{"function_hash":"224142938919271629571588785726484679513","length":1208},"id":"CVE-2025-21693-a227d906","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@8d29ff5d50304daa41dc3cfdda4a9d1e46cf5be1","target":{"file":"mm/zswap.c","function":"zswap_compress"}},{"deprecated":false,"digest":{"line_hashes":["322985496541937988544707259647308408208","103196850735363991198344988266682323468","66019973417194108120442064918294863282","53562994274394621874432152008781414408","203318449016067076710535578502021759550","30696421685003230682618124540727716844","121070193223131961444706448223329674302","160423322788649186020264431847902697951","66021240553966356179274186954714029609","286026176415161049627793520855644059004","261376486899905240694933014032507718357","245595731314120311595749684275558323057","296291836263261869392897490710942915371","149831729816171033805637554229865626052","144284310184935795684935655798759543516","4052157319954824178110601210564892630","77130321727318405316308772980542347660","248315808846044243313043781226307334197","256173649421105142816272680608318833748","160655729980538609788917297495996480393","51771110851351755213985572688582253685","46585128757559500555572279031496063697","287812214900430589248782063983431406871","257368328310720252329708540525095716317","156123968826507558051820699551657231623","148016467466790220935545340140077191983","59968286457018852579211887824548176935","84718293668983124682126004554729526709","128322337997667092732021343665126234476","48232417576973373151980588734360207956","318841922402172055343988176937042476234","294096068500385214676454023967912930256","189589982545189971132216874265908271902","210893234206340745659827637789233427464","301586048132819128090862356791439294756","70979092052656823533536669908922481045","29677817293762427670930902812500632968","301338836386852697049531193172134104030","125979097749236538172274719516927833700","161733432109419371831945701574105620725","6872767574644628517568787374117213942","206435764414270792917015864860670049489","114356949179125050174832084182352139991","35497546382616156281850477892223676751","246574302957465173211655733126684971241","260261575888779048026871596116856322114","24820469075673399338349544829412792141","63704832232080226751136323012412358269","172281898113452636781759197873928414867","276769073491090969493831307688049872899","294190095212423562969887188273566154166","266922472029600371131503620185414153739","65560121491485448978992576632099581036","100359330453816480054954808675205722807"],"threshold":0.9},"id":"CVE-2025-21693-a7a6df0a","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@12dcb0ef540629a281533f9dedc1b6b8e14cfb65","target":{"file":"mm/zswap.c"}},{"deprecated":false,"digest":{"line_hashes":["322985496541937988544707259647308408208","103196850735363991198344988266682323468","66019973417194108120442064918294863282","53562994274394621874432152008781414408","203318449016067076710535578502021759550","30696421685003230682618124540727716844","121070193223131961444706448223329674302","160423322788649186020264431847902697951","66021240553966356179274186954714029609","286026176415161049627793520855644059004","261376486899905240694933014032507718357","245595731314120311595749684275558323057","296291836263261869392897490710942915371","149831729816171033805637554229865626052","144284310184935795684935655798759543516","4052157319954824178110601210564892630","77130321727318405316308772980542347660","248315808846044243313043781226307334197","256173649421105142816272680608318833748","160655729980538609788917297495996480393","51771110851351755213985572688582253685","46585128757559500555572279031496063697","287812214900430589248782063983431406871","257368328310720252329708540525095716317","156123968826507558051820699551657231623","148016467466790220935545340140077191983","59968286457018852579211887824548176935","84718293668983124682126004554729526709","128322337997667092732021343665126234476","48232417576973373151980588734360207956","318841922402172055343988176937042476234","137807980010605394013908509274990539180","117229101026316104238254215585330093083","194044785331095639708735844921684958519","267468551114334656021386955253161632208","334229079798709387484255303791548405090","38003515008842889103555814508177200938","239784661157081895865806768357129105235","284949014764540511972905817053205661550","161733432109419371831945701574105620725","6872767574644628517568787374117213942","206435764414270792917015864860670049489","114356949179125050174832084182352139991","35497546382616156281850477892223676751","246574302957465173211655733126684971241","260261575888779048026871596116856322114","24820469075673399338349544829412792141","63704832232080226751136323012412358269","172281898113452636781759197873928414867","276769073491090969493831307688049872899","294190095212423562969887188273566154166","266922472029600371131503620185414153739","65560121491485448978992576632099581036","100359330453816480054954808675205722807"],"threshold":0.9},"id":"CVE-2025-21693-b4024952","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@8d29ff5d50304daa41dc3cfdda4a9d1e46cf5be1","target":{"file":"mm/zswap.c"}},{"deprecated":false,"digest":{"function_hash":"211920682167081380513445883596754476632","length":1371},"id":"CVE-2025-21693-c5cd7634","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@8d29ff5d50304daa41dc3cfdda4a9d1e46cf5be1","target":{"file":"mm/zswap.c","function":"zswap_pool_create"}},{"deprecated":false,"digest":{"function_hash":"8802529217545175856705918319206230108","length":386},"id":"CVE-2025-21693-ea248ebc","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@8d29ff5d50304daa41dc3cfdda4a9d1e46cf5be1","target":{"file":"mm/zswap.c","function":"zswap_cpu_comp_dead"}}]}},{"package":{"name":"Kernel","ecosystem":"Linux"},"ranges":[{"type":"ECOSYSTEM","events":[{"introduced":"5.11.0"},{"fixed":"6.12.12"}]}],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2025-21693.json"}}],"references":[{"type":"PACKAGE","url":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"},{"type":"WEB","url":"https://git.kernel.org/stable/c/12dcb0ef540629a281533f9dedc1b6b8e14cfb65"},{"type":"WEB","url":"https://git.kernel.org/stable/c/8d29ff5d50304daa41dc3cfdda4a9d1e46cf5be1"}],"severity":[{"type":"CVSS_V3","score":"CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H"}]}