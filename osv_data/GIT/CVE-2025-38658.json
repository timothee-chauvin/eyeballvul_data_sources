{"schema_version":"1.7.3","id":"CVE-2025-38658","published":"2025-08-22T16:01:01.651Z","modified":"2025-11-20T09:55:56.320453Z","summary":"nvmet: pci-epf: Do not complete commands twice if nvmet_req_init() fails","details":"In the Linux kernel, the following vulnerability has been resolved:\n\nnvmet: pci-epf: Do not complete commands twice if nvmet_req_init() fails\n\nHave nvmet_req_init() and req->execute() complete failed commands.\n\nDescription of the problem:\nnvmet_req_init() calls __nvmet_req_complete() internally upon failure,\ne.g., unsupported opcode, which calls the \"queue_response\" callback,\nthis results in nvmet_pci_epf_queue_response() being called, which will\ncall nvmet_pci_epf_complete_iod() if data_len is 0 or if dma_dir is\ndifferent from DMA_TO_DEVICE. This results in a double completion as\nnvmet_pci_epf_exec_iod_work() also calls nvmet_pci_epf_complete_iod()\nwhen nvmet_req_init() fails.\n\nSteps to reproduce:\nOn the host send a command with an unsupported opcode with nvme-cli,\nFor example the admin command \"security receive\"\n$ sudo nvme security-recv /dev/nvme0n1 -n1 -x4096\n\nThis triggers a double completion as nvmet_req_init() fails and\nnvmet_pci_epf_queue_response() is called, here iod->dma_dir is still\nin the default state of \"DMA_NONE\" as set by default in\nnvmet_pci_epf_alloc_iod(), so nvmet_pci_epf_complete_iod() is called.\nBecause nvmet_req_init() failed nvmet_pci_epf_complete_iod() is also\ncalled in nvmet_pci_epf_exec_iod_work() leading to a double completion.\nThis not only sends two completions to the host but also corrupts the\nstate of the PCI NVMe target leading to kernel oops.\n\nThis patch lets nvmet_req_init() and req->execute() complete all failed\ncommands, and removes the double completion case in\nnvmet_pci_epf_exec_iod_work() therefore fixing the edge cases where\ndouble completions occurred.","affected":[{"ranges":[{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"0faa0fe6f90ea59b10d1b0f15ce0eb0c18eff186"},{"fixed":"a535c0b10060bc8c174a7964b0f98064ee0c4774"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"0faa0fe6f90ea59b10d1b0f15ce0eb0c18eff186"},{"fixed":"746d0ac5a07d5da952ef258dd4d75f0b26c96476"}]}],"versions":["v6.13","v6.13-rc5","v6.13-rc6","v6.13-rc7","v6.14","v6.14-rc1","v6.14-rc2","v6.14-rc3","v6.14-rc4","v6.14-rc5","v6.14-rc6","v6.14-rc7","v6.15","v6.15-rc1","v6.15-rc2","v6.15-rc3","v6.15-rc4","v6.15-rc5","v6.15-rc6","v6.15-rc7","v6.16","v6.16-rc1","v6.16-rc2","v6.16-rc3","v6.16-rc4","v6.16-rc5","v6.16-rc6","v6.16-rc7"],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2025-38658.json","vanir_signatures":[{"deprecated":false,"digest":{"function_hash":"189322032892027848778629803235350433211","length":1084},"id":"CVE-2025-38658-28dbaf0e","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@a535c0b10060bc8c174a7964b0f98064ee0c4774","target":{"file":"drivers/nvme/target/pci-epf.c","function":"nvmet_pci_epf_exec_iod_work"}},{"deprecated":false,"digest":{"function_hash":"245163834966851247454704193197843056122","length":316},"id":"CVE-2025-38658-5e5728cb","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@746d0ac5a07d5da952ef258dd4d75f0b26c96476","target":{"file":"drivers/nvme/target/pci-epf.c","function":"nvmet_pci_epf_queue_response"}},{"deprecated":false,"digest":{"line_hashes":["160463011897611313133936316293158875444","173648957574856396929818507178500285117","180311246746178553782244424781369197050","149781624257145625764329261473967492451","26304884806052026235750740392832794139","27258844039154890072037644714309106978","157059497068554045435061279291367419441","15397630796192335396033222363839058430","259459882442182970195093851265468488277","247875890455706256835901140582128903708","162646555921328287267217044290039847065","84846114089342614244778448929828949897","190344126468883842646191234727163213946","296322288342009491883477178310819030119","170866686029148090450739996036400354048","303852424596967758105025262283234626215"],"threshold":0.9},"id":"CVE-2025-38658-87ed90ef","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@746d0ac5a07d5da952ef258dd4d75f0b26c96476","target":{"file":"drivers/nvme/target/pci-epf.c"}},{"deprecated":false,"digest":{"function_hash":"189322032892027848778629803235350433211","length":1084},"id":"CVE-2025-38658-8c9ac53c","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@746d0ac5a07d5da952ef258dd4d75f0b26c96476","target":{"file":"drivers/nvme/target/pci-epf.c","function":"nvmet_pci_epf_exec_iod_work"}},{"deprecated":false,"digest":{"function_hash":"245163834966851247454704193197843056122","length":316},"id":"CVE-2025-38658-d2b39d05","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@a535c0b10060bc8c174a7964b0f98064ee0c4774","target":{"file":"drivers/nvme/target/pci-epf.c","function":"nvmet_pci_epf_queue_response"}},{"deprecated":false,"digest":{"line_hashes":["160463011897611313133936316293158875444","173648957574856396929818507178500285117","180311246746178553782244424781369197050","149781624257145625764329261473967492451","26304884806052026235750740392832794139","27258844039154890072037644714309106978","157059497068554045435061279291367419441","15397630796192335396033222363839058430","259459882442182970195093851265468488277","247875890455706256835901140582128903708","162646555921328287267217044290039847065","84846114089342614244778448929828949897","190344126468883842646191234727163213946","296322288342009491883477178310819030119","170866686029148090450739996036400354048","303852424596967758105025262283234626215"],"threshold":0.9},"id":"CVE-2025-38658-f0718590","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@a535c0b10060bc8c174a7964b0f98064ee0c4774","target":{"file":"drivers/nvme/target/pci-epf.c"}}]}},{"package":{"name":"Kernel","ecosystem":"Linux"},"ranges":[{"type":"ECOSYSTEM","events":[{"introduced":"6.14.0"},{"fixed":"6.16.1"}]}],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2025-38658.json"}}],"references":[{"type":"PACKAGE","url":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"},{"type":"WEB","url":"https://git.kernel.org/stable/c/746d0ac5a07d5da952ef258dd4d75f0b26c96476"},{"type":"WEB","url":"https://git.kernel.org/stable/c/a535c0b10060bc8c174a7964b0f98064ee0c4774"}]}