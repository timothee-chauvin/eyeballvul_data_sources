{
  "affected": [
    {
      "database_specific": {
        "source": "https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2023-53645.json",
        "vanir_signatures": [
          {
            "deprecated": false,
            "digest": {
              "function_hash": "214653964660408935065449200204418649728",
              "length": 288.0
            },
            "id": "CVE-2023-53645-01b15552",
            "signature_type": "Function",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@d906d1b940b9dbf0a3e821d6b32a51c369273d91",
            "target": {
              "file": "tools/testing/selftests/bpf/progs/refcounted_kptr.c",
              "function": "rbtree_refcounted_node_ref_escapes"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "function_hash": "114954608897908742591364149352353712656",
              "length": 11068.0
            },
            "id": "CVE-2023-53645-177bcc9b",
            "signature_type": "Function",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@7793fc3babe9fea908e57f7c187ea819f9fd7e95",
            "target": {
              "file": "kernel/bpf/verifier.c",
              "function": "check_kfunc_args"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "function_hash": "59131170486022382804686103731871692692",
              "length": 267.0
            },
            "id": "CVE-2023-53645-39b8f8b3",
            "signature_type": "Function",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@7793fc3babe9fea908e57f7c187ea819f9fd7e95",
            "target": {
              "file": "tools/testing/selftests/bpf/progs/refcounted_kptr_fail.c",
              "function": "rbtree_refcounted_node_ref_escapes"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "line_hashes": [
                "27877635230366223760768259459879796430",
                "3635085518929409355214589149649503339",
                "116178042047365620253319833483918093704",
                "100635772574359873217775905896474792510",
                "303696776634924453350671518868664331603",
                "264185163721946133744620482758388827196",
                "250619327794771814756535676628654441498",
                "284382392414688495646474384998673031848",
                "325186690415876593335421989749787185424",
                "110277454487474525920350288516524204698",
                "304118163346582980103607397752933160864",
                "156259069278241603059265768971098856964",
                "333980787455451068021340571373892893124",
                "144473282408401784815687633660477178147",
                "231135025954019758939867056841774012819",
                "82377630872944602688468095247804953427",
                "20248663814075875948593562240392429244",
                "132408331318417174322071432942062169061",
                "45146266290063056411793288663074023741",
                "105303035106068422126379441579134564496",
                "67279660825219292483291533773004773143",
                "278403921917651320175018385448581239644"
              ],
              "threshold": 0.9
            },
            "id": "CVE-2023-53645-6478eac0",
            "signature_type": "Line",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@7793fc3babe9fea908e57f7c187ea819f9fd7e95",
            "target": {
              "file": "kernel/bpf/verifier.c"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "line_hashes": [
                "40289054989972170521967997755045003830",
                "211200915062630411351435686441303036607",
                "227422973899418099178742506114741373179",
                "27386052806680370774847206154344626154"
              ],
              "threshold": 0.9
            },
            "id": "CVE-2023-53645-8a74137b",
            "signature_type": "Line",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@7793fc3babe9fea908e57f7c187ea819f9fd7e95",
            "target": {
              "file": "tools/testing/selftests/bpf/progs/refcounted_kptr.c"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "function_hash": "59131170486022382804686103731871692692",
              "length": 267.0
            },
            "id": "CVE-2023-53645-8c57e2b3",
            "signature_type": "Function",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@d906d1b940b9dbf0a3e821d6b32a51c369273d91",
            "target": {
              "file": "tools/testing/selftests/bpf/progs/refcounted_kptr_fail.c",
              "function": "rbtree_refcounted_node_ref_escapes"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "line_hashes": [
                "40289054989972170521967997755045003830",
                "211200915062630411351435686441303036607",
                "227422973899418099178742506114741373179",
                "27386052806680370774847206154344626154"
              ],
              "threshold": 0.9
            },
            "id": "CVE-2023-53645-967480e4",
            "signature_type": "Line",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@d906d1b940b9dbf0a3e821d6b32a51c369273d91",
            "target": {
              "file": "tools/testing/selftests/bpf/progs/refcounted_kptr.c"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "function_hash": "90971979391093687642217375902995676636",
              "length": 87.0
            },
            "id": "CVE-2023-53645-9d48f8f7",
            "signature_type": "Function",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@7793fc3babe9fea908e57f7c187ea819f9fd7e95",
            "target": {
              "file": "kernel/bpf/verifier.c",
              "function": "is_kfunc_ret_null"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "line_hashes": [
                "27877635230366223760768259459879796430",
                "3635085518929409355214589149649503339",
                "116178042047365620253319833483918093704",
                "100635772574359873217775905896474792510",
                "303696776634924453350671518868664331603",
                "264185163721946133744620482758388827196",
                "250619327794771814756535676628654441498",
                "284382392414688495646474384998673031848",
                "325186690415876593335421989749787185424",
                "110277454487474525920350288516524204698",
                "304118163346582980103607397752933160864",
                "156259069278241603059265768971098856964",
                "240190238316386254641838975333703840937",
                "233100041307889250923005549387287952748",
                "174587508043469656470778549213646360746",
                "82377630872944602688468095247804953427",
                "20248663814075875948593562240392429244",
                "132408331318417174322071432942062169061",
                "45146266290063056411793288663074023741",
                "105303035106068422126379441579134564496",
                "67279660825219292483291533773004773143",
                "278403921917651320175018385448581239644"
              ],
              "threshold": 0.9
            },
            "id": "CVE-2023-53645-a0827811",
            "signature_type": "Line",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@d906d1b940b9dbf0a3e821d6b32a51c369273d91",
            "target": {
              "file": "kernel/bpf/verifier.c"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "function_hash": "90971979391093687642217375902995676636",
              "length": 87.0
            },
            "id": "CVE-2023-53645-afb7a4cc",
            "signature_type": "Function",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@d906d1b940b9dbf0a3e821d6b32a51c369273d91",
            "target": {
              "file": "kernel/bpf/verifier.c",
              "function": "is_kfunc_ret_null"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "line_hashes": [
                "53761924428679235003597751970252564907",
                "267954969120915453967110948253286237234",
                "219671588633837172090297676137501660482",
                "214380199879578533969299967003290209199",
                "23827158036763476948379183996223868972",
                "152992669581987722396662039969627027621",
                "240001263171751599341521459081355751806",
                "171752495368079126989734437859677361373"
              ],
              "threshold": 0.9
            },
            "id": "CVE-2023-53645-c243a780",
            "signature_type": "Line",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@d906d1b940b9dbf0a3e821d6b32a51c369273d91",
            "target": {
              "file": "tools/testing/selftests/bpf/progs/refcounted_kptr_fail.c"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "function_hash": "58808727147076823470246923528136436262",
              "length": 210.0
            },
            "id": "CVE-2023-53645-c6f3b9d9",
            "signature_type": "Function",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@7793fc3babe9fea908e57f7c187ea819f9fd7e95",
            "target": {
              "file": "kernel/bpf/helpers.c",
              "function": "bpf_refcount_acquire_impl"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "function_hash": "58808727147076823470246923528136436262",
              "length": 210.0
            },
            "id": "CVE-2023-53645-d042b4da",
            "signature_type": "Function",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@d906d1b940b9dbf0a3e821d6b32a51c369273d91",
            "target": {
              "file": "kernel/bpf/helpers.c",
              "function": "bpf_refcount_acquire_impl"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "line_hashes": [
                "138850214971714331508013246995543028898",
                "129335708694888572737587341410054207612",
                "118317820238347574790658146102051075785",
                "284501968612450609793604931281435663686",
                "180179894110860630773712749035842975888",
                "99283273704053123257054020289788824645",
                "93460353326128952787970677952512850444",
                "196921924079332143286113470081947553904",
                "240092487705050981538568649105869998854"
              ],
              "threshold": 0.9
            },
            "id": "CVE-2023-53645-d3f21a8f",
            "signature_type": "Line",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@d906d1b940b9dbf0a3e821d6b32a51c369273d91",
            "target": {
              "file": "kernel/bpf/helpers.c"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "line_hashes": [
                "53761924428679235003597751970252564907",
                "267954969120915453967110948253286237234",
                "219671588633837172090297676137501660482",
                "214380199879578533969299967003290209199",
                "23827158036763476948379183996223868972",
                "152992669581987722396662039969627027621",
                "240001263171751599341521459081355751806",
                "171752495368079126989734437859677361373"
              ],
              "threshold": 0.9
            },
            "id": "CVE-2023-53645-e338a40d",
            "signature_type": "Line",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@7793fc3babe9fea908e57f7c187ea819f9fd7e95",
            "target": {
              "file": "tools/testing/selftests/bpf/progs/refcounted_kptr_fail.c"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "function_hash": "214653964660408935065449200204418649728",
              "length": 288.0
            },
            "id": "CVE-2023-53645-e6c1a475",
            "signature_type": "Function",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@7793fc3babe9fea908e57f7c187ea819f9fd7e95",
            "target": {
              "file": "tools/testing/selftests/bpf/progs/refcounted_kptr.c",
              "function": "rbtree_refcounted_node_ref_escapes"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "line_hashes": [
                "138850214971714331508013246995543028898",
                "129335708694888572737587341410054207612",
                "118317820238347574790658146102051075785",
                "284501968612450609793604931281435663686",
                "180179894110860630773712749035842975888",
                "99283273704053123257054020289788824645",
                "93460353326128952787970677952512850444",
                "196921924079332143286113470081947553904",
                "240092487705050981538568649105869998854"
              ],
              "threshold": 0.9
            },
            "id": "CVE-2023-53645-ea3ab7f3",
            "signature_type": "Line",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@7793fc3babe9fea908e57f7c187ea819f9fd7e95",
            "target": {
              "file": "kernel/bpf/helpers.c"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "function_hash": "17532933252067928947452064445276324523",
              "length": 10296.0
            },
            "id": "CVE-2023-53645-ed38f79e",
            "signature_type": "Function",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@d906d1b940b9dbf0a3e821d6b32a51c369273d91",
            "target": {
              "file": "kernel/bpf/verifier.c",
              "function": "check_kfunc_args"
            }
          }
        ]
      },
      "ranges": [
        {
          "events": [
            {
              "introduced": "d2dcc67df910dd85253a701b6a5b747f955d28f5"
            },
            {
              "fixed": "d906d1b940b9dbf0a3e821d6b32a51c369273d91"
            }
          ],
          "repo": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git",
          "type": "GIT"
        },
        {
          "events": [
            {
              "introduced": "d2dcc67df910dd85253a701b6a5b747f955d28f5"
            },
            {
              "fixed": "7793fc3babe9fea908e57f7c187ea819f9fd7e95"
            }
          ],
          "repo": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git",
          "type": "GIT"
        }
      ],
      "versions": [
        "v6.3",
        "v6.3-rc7",
        "v6.4",
        "v6.4-rc1",
        "v6.4-rc2",
        "v6.4-rc3",
        "v6.4-rc4",
        "v6.4-rc5",
        "v6.4-rc6",
        "v6.4-rc7",
        "v6.4.1",
        "v6.4.2",
        "v6.4.3"
      ]
    },
    {
      "database_specific": {
        "source": "https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2023-53645.json"
      },
      "package": {
        "ecosystem": "Linux",
        "name": "Kernel"
      },
      "ranges": [
        {
          "events": [
            {
              "introduced": "6.4.0"
            },
            {
              "fixed": "6.4.4"
            }
          ],
          "type": "ECOSYSTEM"
        }
      ],
      "versions": []
    }
  ],
  "details": "In the Linux kernel, the following vulnerability has been resolved:\n\nbpf: Make bpf_refcount_acquire fallible for non-owning refs\n\nThis patch fixes an incorrect assumption made in the original\nbpf_refcount series [0], specifically that the BPF program calling\nbpf_refcount_acquire on some node can always guarantee that the node is\nalive. In that series, the patch adding failure behavior to rbtree_add\nand list_push_{front, back} breaks this assumption for non-owning\nreferences.\n\nConsider the following program:\n\n  n = bpf_kptr_xchg(&mapval, NULL);\n  /* skip error checking */\n\n  bpf_spin_lock(&l);\n  if(bpf_rbtree_add(&t, &n->rb, less)) {\n    bpf_refcount_acquire(n);\n    /* Failed to add, do something else with the node */\n  }\n  bpf_spin_unlock(&l);\n\nIt's incorrect to assume that bpf_refcount_acquire will always succeed in this\nscenario. bpf_refcount_acquire is being called in a critical section\nhere, but the lock being held is associated with rbtree t, which isn't\nnecessarily the lock associated with the tree that the node is already\nin. So after bpf_rbtree_add fails to add the node and calls bpf_obj_drop\nin it, the program has no ownership of the node's lifetime. Therefore\nthe node's refcount can be decr'd to 0 at any time after the failing\nrbtree_add. If this happens before the refcount_acquire above, the node\nmight be free'd, and regardless refcount_acquire will be incrementing a\n0 refcount.\n\nLater patches in the series exercise this scenario, resulting in the\nexpected complaint from the kernel (without this patch's changes):\n\n  refcount_t: addition on 0; use-after-free.\n  WARNING: CPU: 1 PID: 207 at lib/refcount.c:25 refcount_warn_saturate+0xbc/0x110\n  Modules linked in: bpf_testmod(O)\n  CPU: 1 PID: 207 Comm: test_progs Tainted: G           O       6.3.0-rc7-02231-g723de1a718a2-dirty #371\n  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.15.0-0-g2dd4b9b3f840-prebuilt.qemu.org 04/01/2014\n  RIP: 0010:refcount_warn_saturate+0xbc/0x110\n  Code: 6f 64 f6 02 01 e8 84 a3 5c ff 0f 0b eb 9d 80 3d 5e 64 f6 02 00 75 94 48 c7 c7 e0 13 d2 82 c6 05 4e 64 f6 02 01 e8 64 a3 5c ff <0f> 0b e9 7a ff ff ff 80 3d 38 64 f6 02 00 0f 85 6d ff ff ff 48 c7\n  RSP: 0018:ffff88810b9179b0 EFLAGS: 00010082\n  RAX: 0000000000000000 RBX: 0000000000000002 RCX: 0000000000000000\n  RDX: 0000000000000202 RSI: 0000000000000008 RDI: ffffffff857c3680\n  RBP: ffff88810027d3c0 R08: ffffffff8125f2a4 R09: ffff88810b9176e7\n  R10: ffffed1021722edc R11: 746e756f63666572 R12: ffff88810027d388\n  R13: ffff88810027d3c0 R14: ffffc900005fe030 R15: ffffc900005fe048\n  FS:  00007fee0584a700(0000) GS:ffff88811b280000(0000) knlGS:0000000000000000\n  CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n  CR2: 00005634a96f6c58 CR3: 0000000108ce9002 CR4: 0000000000770ee0\n  DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000\n  DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400\n  PKRU: 55555554\n  Call Trace:\n   <TASK>\n   bpf_refcount_acquire_impl+0xb5/0xc0\n\n  (rest of output snipped)\n\nThe patch addresses this by changing bpf_refcount_acquire_impl to use\nrefcount_inc_not_zero instead of refcount_inc and marking\nbpf_refcount_acquire KF_RET_NULL.\n\nFor owning references, though, we know the above scenario is not possible\nand thus that bpf_refcount_acquire will always succeed. Some verifier\nbookkeeping is added to track \"is input owning ref?\" for bpf_refcount_acquire\ncalls and return false from is_kfunc_ret_null for bpf_refcount_acquire on\nowning refs despite it being marked KF_RET_NULL.\n\nExisting selftests using bpf_refcount_acquire are modified where\nnecessary to NULL-check its return value.\n\n  [0]: https://lore.kernel.org/bpf/20230415201811.343116-1-davemarchevsky@fb.com/",
  "id": "CVE-2023-53645",
  "modified": "2025-10-15T07:27:37.395332Z",
  "published": "2025-10-07T15:19:43Z",
  "references": [
    {
      "type": "PACKAGE",
      "url": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"
    },
    {
      "type": "WEB",
      "url": "https://git.kernel.org/stable/c/7793fc3babe9fea908e57f7c187ea819f9fd7e95"
    },
    {
      "type": "WEB",
      "url": "https://git.kernel.org/stable/c/d906d1b940b9dbf0a3e821d6b32a51c369273d91"
    }
  ],
  "schema_version": "1.7.3",
  "summary": "bpf: Make bpf_refcount_acquire fallible for non-owning refs"
}