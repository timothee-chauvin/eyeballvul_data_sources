{"schema_version":"1.7.3","id":"CVE-2022-49003","published":"2024-10-21T20:06:16Z","modified":"2025-10-21T08:00:44.958712Z","related":["SUSE-SU-2024:3983-1","SUSE-SU-2024:3985-1","SUSE-SU-2024:4081-1","SUSE-SU-2024:4082-1","SUSE-SU-2024:4103-1","SUSE-SU-2024:4131-1","SUSE-SU-2024:4140-1","SUSE-SU-2024:4364-1"],"summary":"nvme: fix SRCU protection of nvme_ns_head list","details":"In the Linux kernel, the following vulnerability has been resolved:\n\nnvme: fix SRCU protection of nvme_ns_head list\n\nWalking the nvme_ns_head siblings list is protected by the head's srcu\nin nvme_ns_head_submit_bio() but not nvme_mpath_revalidate_paths().\nRemoving namespaces from the list also fails to synchronize the srcu.\nConcurrent scan work can therefore cause use-after-frees.\n\nHold the head's srcu lock in nvme_mpath_revalidate_paths() and\nsynchronize with the srcu, not the global RCU, in nvme_ns_remove().\n\nObserved the following panic when making NVMe/RDMA connections\nwith native multipath on the Rocky Linux 8.6 kernel\n(it seems the upstream kernel has the same race condition).\nDisassembly shows the faulting instruction is cmp 0x50(%rdx),%rcx;\ncomputing capacity != get_capacity(ns->disk).\nAddress 0x50 is dereferenced because ns->disk is NULL.\nThe NULL disk appears to be the result of concurrent scan work\nfreeing the namespace (note the log line in the middle of the panic).\n\n[37314.206036] BUG: unable to handle kernel NULL pointer dereference at 0000000000000050\n[37314.206036] nvme0n3: detected capacity change from 0 to 11811160064\n[37314.299753] PGD 0 P4D 0\n[37314.299756] Oops: 0000 [#1] SMP PTI\n[37314.299759] CPU: 29 PID: 322046 Comm: kworker/u98:3 Kdump: loaded Tainted: G        W      X --------- -  - 4.18.0-372.32.1.el8test86.x86_64 #1\n[37314.299762] Hardware name: Dell Inc. PowerEdge R720/0JP31P, BIOS 2.7.0 05/23/2018\n[37314.299763] Workqueue: nvme-wq nvme_scan_work [nvme_core]\n[37314.299783] RIP: 0010:nvme_mpath_revalidate_paths+0x26/0xb0 [nvme_core]\n[37314.299790] Code: 1f 44 00 00 66 66 66 66 90 55 53 48 8b 5f 50 48 8b 83 c8 c9 00 00 48 8b 13 48 8b 48 50 48 39 d3 74 20 48 8d 42 d0 48 8b 50 20 <48> 3b 4a 50 74 05 f0 80 60 70 ef 48 8b 50 30 48 8d 42 d0 48 39 d3\n[37315.058803] RSP: 0018:ffffabe28f913d10 EFLAGS: 00010202\n[37315.121316] RAX: ffff927a077da800 RBX: ffff92991dd70000 RCX: 0000000001600000\n[37315.206704] RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffff92991b719800\n[37315.292106] RBP: ffff929a6b70c000 R08: 000000010234cd4a R09: c0000000ffff7fff\n[37315.377501] R10: 0000000000000001 R11: ffffabe28f913a30 R12: 0000000000000000\n[37315.462889] R13: ffff92992716600c R14: ffff929964e6e030 R15: ffff92991dd70000\n[37315.548286] FS:  0000000000000000(0000) GS:ffff92b87fb80000(0000) knlGS:0000000000000000\n[37315.645111] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n[37315.713871] CR2: 0000000000000050 CR3: 0000002208810006 CR4: 00000000000606e0\n[37315.799267] Call Trace:\n[37315.828515]  nvme_update_ns_info+0x1ac/0x250 [nvme_core]\n[37315.892075]  nvme_validate_or_alloc_ns+0x2ff/0xa00 [nvme_core]\n[37315.961871]  ? __blk_mq_free_request+0x6b/0x90\n[37316.015021]  nvme_scan_work+0x151/0x240 [nvme_core]\n[37316.073371]  process_one_work+0x1a7/0x360\n[37316.121318]  ? create_worker+0x1a0/0x1a0\n[37316.168227]  worker_thread+0x30/0x390\n[37316.212024]  ? create_worker+0x1a0/0x1a0\n[37316.258939]  kthread+0x10a/0x120\n[37316.297557]  ? set_kthread_struct+0x50/0x50\n[37316.347590]  ret_from_fork+0x35/0x40\n[37316.390360] Modules linked in: nvme_rdma nvme_tcp(X) nvme_fabrics nvme_core netconsole iscsi_tcp libiscsi_tcp dm_queue_length dm_service_time nf_conntrack_netlink br_netfilter bridge stp llc overlay nft_chain_nat ipt_MASQUERADE nf_nat xt_addrtype xt_CT nft_counter xt_state xt_conntrack nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 xt_comment xt_multiport nft_compat nf_tables libcrc32c nfnetlink dm_multipath tg3 rpcrdma sunrpc rdma_ucm ib_srpt ib_isert iscsi_target_mod target_core_mod ib_iser libiscsi scsi_transport_iscsi ib_umad rdma_cm ib_ipoib iw_cm ib_cm intel_rapl_msr iTCO_wdt iTCO_vendor_support dcdbas intel_rapl_common sb_edac x86_pkg_temp_thermal intel_powerclamp coretemp kvm_intel ipmi_ssif kvm irqbypass crct10dif_pclmul crc32_pclmul mlx5_ib ghash_clmulni_intel ib_uverbs rapl intel_cstate intel_uncore ib_core ipmi_si joydev mei_me pcspkr ipmi_devintf mei lpc_ich wmi ipmi_msghandler acpi_power_meter ex\n---truncated---","affected":[{"ranges":[{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"e7d65803e2bb5bc739548b67a5fc72c626cf7e3b"},{"fixed":"787d81d4eb150e443e5d1276c6e8f03cfecc2302"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"e7d65803e2bb5bc739548b67a5fc72c626cf7e3b"},{"fixed":"5b566d09ab1b975566a53f9c5466ee260d087582"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"e7d65803e2bb5bc739548b67a5fc72c626cf7e3b"},{"fixed":"899d2a05dc14733cfba6224083c6b0dd5a738590"}]}],"versions":["v5.15","v5.15-rc1","v5.15-rc2","v5.15-rc3","v5.15-rc4","v5.15-rc5","v5.15-rc6","v5.15-rc7","v5.15.1","v5.15.10","v5.15.11","v5.15.12","v5.15.13","v5.15.14","v5.15.15","v5.15.16","v5.15.17","v5.15.18","v5.15.19","v5.15.2","v5.15.20","v5.15.21","v5.15.22","v5.15.23","v5.15.24","v5.15.25","v5.15.26","v5.15.27","v5.15.28","v5.15.29","v5.15.3","v5.15.30","v5.15.31","v5.15.32","v5.15.33","v5.15.34","v5.15.35","v5.15.36","v5.15.37","v5.15.38","v5.15.39","v5.15.4","v5.15.40","v5.15.41","v5.15.42","v5.15.43","v5.15.44","v5.15.45","v5.15.46","v5.15.47","v5.15.48","v5.15.49","v5.15.5","v5.15.50","v5.15.51","v5.15.52","v5.15.53","v5.15.54","v5.15.55","v5.15.56","v5.15.57","v5.15.58","v5.15.59","v5.15.6","v5.15.60","v5.15.61","v5.15.62","v5.15.63","v5.15.64","v5.15.65","v5.15.66","v5.15.67","v5.15.68","v5.15.69","v5.15.7","v5.15.70","v5.15.71","v5.15.72","v5.15.73","v5.15.74","v5.15.75","v5.15.76","v5.15.77","v5.15.78","v5.15.79","v5.15.8","v5.15.80","v5.15.81","v5.15.9","v5.16","v5.16-rc1","v5.16-rc2","v5.16-rc3","v5.16-rc4","v5.16-rc5","v5.16-rc6","v5.16-rc7","v5.16-rc8","v5.17","v5.17-rc1","v5.17-rc2","v5.17-rc3","v5.17-rc4","v5.17-rc5","v5.17-rc6","v5.17-rc7","v5.17-rc8","v5.18","v5.18-rc1","v5.18-rc2","v5.18-rc3","v5.18-rc4","v5.18-rc5","v5.18-rc6","v5.18-rc7","v5.19","v5.19-rc1","v5.19-rc2","v5.19-rc3","v5.19-rc4","v5.19-rc5","v5.19-rc6","v5.19-rc7","v5.19-rc8","v6.0","v6.0-rc1","v6.0-rc2","v6.0-rc3","v6.0-rc4","v6.0-rc5","v6.0-rc6","v6.0-rc7","v6.0.1","v6.0.10","v6.0.11","v6.0.2","v6.0.3","v6.0.4","v6.0.5","v6.0.6","v6.0.7","v6.0.8","v6.0.9"],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2022-49003.json","vanir_signatures":[{"deprecated":false,"digest":{"line_hashes":["251363999658314378919406745157021095627","142595626163599362712250258192967840815","173658428457820215066186675745162450152","337470937221848852232917901528988872564"],"threshold":0.9},"id":"CVE-2022-49003-04866106","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@899d2a05dc14733cfba6224083c6b0dd5a738590","target":{"file":"drivers/nvme/host/core.c"}},{"deprecated":false,"digest":{"line_hashes":["251363999658314378919406745157021095627","152929277789085317697028181027413889293","243121822064178515110612150503182324461","125120466776952845548672183249374480573"],"threshold":0.9},"id":"CVE-2022-49003-09f65c90","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@787d81d4eb150e443e5d1276c6e8f03cfecc2302","target":{"file":"drivers/nvme/host/core.c"}},{"deprecated":false,"digest":{"line_hashes":["204366457635873537101978282716190156073","116616256280128272660380277662595600222","30314691695429581206494076151258635828","121309396358756759994928662565442067199","258668591138616692339271043972968656974","140359136803257688144740723226926140422","115202856450913903568889062375090152490","235113712796648439819795426204121121048"],"threshold":0.9},"id":"CVE-2022-49003-636a0381","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@899d2a05dc14733cfba6224083c6b0dd5a738590","target":{"file":"drivers/nvme/host/multipath.c"}},{"deprecated":false,"digest":{"function_hash":"308163419240340954435471933331976180845","length":385},"id":"CVE-2022-49003-88051d5f","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@899d2a05dc14733cfba6224083c6b0dd5a738590","target":{"file":"drivers/nvme/host/multipath.c","function":"nvme_mpath_revalidate_paths"}},{"deprecated":false,"digest":{"function_hash":"281657234110106688543217375735883651021","length":916},"id":"CVE-2022-49003-90872679","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@5b566d09ab1b975566a53f9c5466ee260d087582","target":{"file":"drivers/nvme/host/core.c","function":"nvme_ns_remove"}},{"deprecated":false,"digest":{"function_hash":"308163419240340954435471933331976180845","length":385},"id":"CVE-2022-49003-9129a9bc","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@787d81d4eb150e443e5d1276c6e8f03cfecc2302","target":{"file":"drivers/nvme/host/multipath.c","function":"nvme_mpath_revalidate_paths"}},{"deprecated":false,"digest":{"line_hashes":["204366457635873537101978282716190156073","116616256280128272660380277662595600222","30314691695429581206494076151258635828","121309396358756759994928662565442067199","258668591138616692339271043972968656974","140359136803257688144740723226926140422","115202856450913903568889062375090152490","235113712796648439819795426204121121048"],"threshold":0.9},"id":"CVE-2022-49003-924adf51","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@5b566d09ab1b975566a53f9c5466ee260d087582","target":{"file":"drivers/nvme/host/multipath.c"}},{"deprecated":false,"digest":{"function_hash":"50190204965100741242564086851742526899","length":907},"id":"CVE-2022-49003-b3218e34","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@787d81d4eb150e443e5d1276c6e8f03cfecc2302","target":{"file":"drivers/nvme/host/core.c","function":"nvme_ns_remove"}},{"deprecated":false,"digest":{"line_hashes":["204366457635873537101978282716190156073","116616256280128272660380277662595600222","30314691695429581206494076151258635828","121309396358756759994928662565442067199","258668591138616692339271043972968656974","140359136803257688144740723226926140422","115202856450913903568889062375090152490","235113712796648439819795426204121121048"],"threshold":0.9},"id":"CVE-2022-49003-d5a600f8","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@787d81d4eb150e443e5d1276c6e8f03cfecc2302","target":{"file":"drivers/nvme/host/multipath.c"}},{"deprecated":false,"digest":{"function_hash":"281657234110106688543217375735883651021","length":916},"id":"CVE-2022-49003-db23229a","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@899d2a05dc14733cfba6224083c6b0dd5a738590","target":{"file":"drivers/nvme/host/core.c","function":"nvme_ns_remove"}},{"deprecated":false,"digest":{"function_hash":"308163419240340954435471933331976180845","length":385},"id":"CVE-2022-49003-e81604fd","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@5b566d09ab1b975566a53f9c5466ee260d087582","target":{"file":"drivers/nvme/host/multipath.c","function":"nvme_mpath_revalidate_paths"}},{"deprecated":false,"digest":{"line_hashes":["251363999658314378919406745157021095627","142595626163599362712250258192967840815","173658428457820215066186675745162450152","337470937221848852232917901528988872564"],"threshold":0.9},"id":"CVE-2022-49003-f6b4ce92","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@5b566d09ab1b975566a53f9c5466ee260d087582","target":{"file":"drivers/nvme/host/core.c"}}]}},{"package":{"name":"Kernel","ecosystem":"Linux"},"ranges":[{"type":"ECOSYSTEM","events":[{"introduced":"5.15.0"},{"fixed":"5.15.82"}]},{"type":"ECOSYSTEM","events":[{"introduced":"5.16.0"},{"fixed":"6.0.12"}]}],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2022-49003.json"}}],"references":[{"type":"PACKAGE","url":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"},{"type":"WEB","url":"https://git.kernel.org/stable/c/5b566d09ab1b975566a53f9c5466ee260d087582"},{"type":"WEB","url":"https://git.kernel.org/stable/c/787d81d4eb150e443e5d1276c6e8f03cfecc2302"},{"type":"WEB","url":"https://git.kernel.org/stable/c/899d2a05dc14733cfba6224083c6b0dd5a738590"}]}