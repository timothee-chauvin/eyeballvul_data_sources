{"schema_version":"1.7.3","id":"CVE-2024-35798","published":"2024-05-17T13:23:08.868Z","modified":"2025-11-20T04:14:33.740304Z","summary":"btrfs: fix race in read_extent_buffer_pages()","details":"In the Linux kernel, the following vulnerability has been resolved:\n\nbtrfs: fix race in read_extent_buffer_pages()\n\nThere are reports from tree-checker that detects corrupted nodes,\nwithout any obvious pattern so possibly an overwrite in memory.\nAfter some debugging it turns out there's a race when reading an extent\nbuffer the uptodate status can be missed.\n\nTo prevent concurrent reads for the same extent buffer,\nread_extent_buffer_pages() performs these checks:\n\n    /* (1) */\n    if (test_bit(EXTENT_BUFFER_UPTODATE, &eb->bflags))\n        return 0;\n\n    /* (2) */\n    if (test_and_set_bit(EXTENT_BUFFER_READING, &eb->bflags))\n        goto done;\n\nAt this point, it seems safe to start the actual read operation. Once\nthat completes, end_bbio_meta_read() does\n\n    /* (3) */\n    set_extent_buffer_uptodate(eb);\n\n    /* (4) */\n    clear_bit(EXTENT_BUFFER_READING, &eb->bflags);\n\nNormally, this is enough to ensure only one read happens, and all other\ncallers wait for it to finish before returning.  Unfortunately, there is\na racey interleaving:\n\n    Thread A | Thread B | Thread C\n    ---------+----------+---------\n       (1)   |          |\n             |    (1)   |\n       (2)   |          |\n       (3)   |          |\n       (4)   |          |\n             |    (2)   |\n             |          |    (1)\n\nWhen this happens, thread B kicks of an unnecessary read. Worse, thread\nC will see UPTODATE set and return immediately, while the read from\nthread B is still in progress.  This race could result in tree-checker\nerrors like this as the extent buffer is concurrently modified:\n\n    BTRFS critical (device dm-0): corrupted node, root=256\n    block=8550954455682405139 owner mismatch, have 11858205567642294356\n    expect [256, 18446744073709551360]\n\nFix it by testing UPTODATE again after setting the READING bit, and if\nit's been set, skip the unnecessary read.\n\n[ minor update of changelog ]","affected":[{"ranges":[{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"d7172f52e9933b6ec9305e7fe6e829e3939dba04"},{"fixed":"0427c8ef8bbb7f304de42ef51d69c960e165e052"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"d7172f52e9933b6ec9305e7fe6e829e3939dba04"},{"fixed":"3a25878a3378adce5d846300c9570f15aa7f7a80"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"d7172f52e9933b6ec9305e7fe6e829e3939dba04"},{"fixed":"2885d54af2c2e1d910e20d5c8045bae40e02fbc1"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"d7172f52e9933b6ec9305e7fe6e829e3939dba04"},{"fixed":"ef1e68236b9153c27cb7cf29ead0c532870d4215"}]}],"versions":["v6.4","v6.5","v6.5-rc1","v6.5-rc2","v6.5-rc3","v6.5-rc4","v6.5-rc5","v6.5-rc6","v6.5-rc7","v6.6","v6.6-rc1","v6.6-rc2","v6.6-rc3","v6.6-rc4","v6.6-rc5","v6.6-rc6","v6.6-rc7","v6.6.1","v6.6.10","v6.6.11","v6.6.12","v6.6.13","v6.6.14","v6.6.15","v6.6.16","v6.6.17","v6.6.18","v6.6.19","v6.6.2","v6.6.20","v6.6.21","v6.6.22","v6.6.23","v6.6.3","v6.6.4","v6.6.5","v6.6.6","v6.6.7","v6.6.8","v6.6.9","v6.7","v6.7-rc1","v6.7-rc2","v6.7-rc3","v6.7-rc4","v6.7-rc5","v6.7-rc6","v6.7-rc7","v6.7-rc8","v6.7.1","v6.7.10","v6.7.11","v6.7.2","v6.7.3","v6.7.4","v6.7.5","v6.7.6","v6.7.7","v6.7.8","v6.7.9","v6.8","v6.8-rc1","v6.8-rc2","v6.8-rc3","v6.8-rc4","v6.8-rc5","v6.8-rc6","v6.8-rc7","v6.8.1","v6.8.2"],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2024-35798.json","vanir_signatures":[{"deprecated":false,"digest":{"line_hashes":["244860295154560914661115200884769415830","151550505142823828944155927973984918043","176825488235561253652456416284285015049"],"threshold":0.9},"id":"CVE-2024-35798-2d6635f9","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@2885d54af2c2e1d910e20d5c8045bae40e02fbc1","target":{"file":"fs/btrfs/extent_io.c"}},{"deprecated":false,"digest":{"function_hash":"259234399510024586390112242357818798583","length":1486},"id":"CVE-2024-35798-362a0e41","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@2885d54af2c2e1d910e20d5c8045bae40e02fbc1","target":{"file":"fs/btrfs/extent_io.c","function":"read_extent_buffer_pages"}},{"deprecated":false,"digest":{"line_hashes":["244860295154560914661115200884769415830","151550505142823828944155927973984918043","176825488235561253652456416284285015049"],"threshold":0.9},"id":"CVE-2024-35798-69e15242","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@ef1e68236b9153c27cb7cf29ead0c532870d4215","target":{"file":"fs/btrfs/extent_io.c"}},{"deprecated":false,"digest":{"function_hash":"117316053210905963425233943332691565237","length":1489},"id":"CVE-2024-35798-f20480a5","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@ef1e68236b9153c27cb7cf29ead0c532870d4215","target":{"file":"fs/btrfs/extent_io.c","function":"read_extent_buffer_pages"}}]}},{"package":{"name":"Kernel","ecosystem":"Linux"},"ranges":[{"type":"ECOSYSTEM","events":[{"introduced":"6.5.0"},{"fixed":"6.6.24"}]},{"type":"ECOSYSTEM","events":[{"introduced":"6.7.0"},{"fixed":"6.7.12"}]},{"type":"ECOSYSTEM","events":[{"introduced":"6.8.0"},{"fixed":"6.8.3"}]}],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2024-35798.json"}}],"references":[{"type":"PACKAGE","url":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"},{"type":"WEB","url":"https://git.kernel.org/stable/c/0427c8ef8bbb7f304de42ef51d69c960e165e052"},{"type":"WEB","url":"https://git.kernel.org/stable/c/2885d54af2c2e1d910e20d5c8045bae40e02fbc1"},{"type":"WEB","url":"https://git.kernel.org/stable/c/3a25878a3378adce5d846300c9570f15aa7f7a80"},{"type":"WEB","url":"https://git.kernel.org/stable/c/ef1e68236b9153c27cb7cf29ead0c532870d4215"}]}