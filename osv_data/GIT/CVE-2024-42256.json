{"schema_version":"1.7.3","id":"CVE-2024-42256","published":"2024-08-08T08:49:15.813Z","modified":"2025-11-20T05:01:54.307304Z","summary":"cifs: Fix server re-repick on subrequest retry","details":"In the Linux kernel, the following vulnerability has been resolved:\n\ncifs: Fix server re-repick on subrequest retry\n\nWhen a subrequest is marked for needing retry, netfs will call\ncifs_prepare_write() which will make cifs repick the server for the op\nbefore renegotiating credits; it then calls cifs_issue_write() which\ninvokes smb2_async_writev() - which re-repicks the server.\n\nIf a different server is then selected, this causes the increment of\nserver->in_flight to happen against one record and the decrement to happen\nagainst another, leading to misaccounting.\n\nFix this by just removing the repick code in smb2_async_writev().  As this\nis only called from netfslib-driven code, cifs_prepare_write() should\nalways have been called first, and so server should never be NULL and the\npreparatory step is repeated in the event that we do a retry.\n\nThe problem manifests as a warning looking something like:\n\n WARNING: CPU: 4 PID: 72896 at fs/smb/client/smb2ops.c:97 smb2_add_credits+0x3f0/0x9e0 [cifs]\n ...\n RIP: 0010:smb2_add_credits+0x3f0/0x9e0 [cifs]\n ...\n  smb2_writev_callback+0x334/0x560 [cifs]\n  cifs_demultiplex_thread+0x77a/0x11b0 [cifs]\n  kthread+0x187/0x1d0\n  ret_from_fork+0x34/0x60\n  ret_from_fork_asm+0x1a/0x30\n\nWhich may be triggered by a number of different xfstests running against an\nAzure server in multichannel mode.  generic/249 seems the most repeatable,\nbut generic/215, generic/249 and generic/308 may also show it.","affected":[{"ranges":[{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"3ee1a1fc39819906f04d6c62c180e760cd3a689d"},{"fixed":"b1d0a566769b6fb3795b5289fc1daf9e0638d97a"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"3ee1a1fc39819906f04d6c62c180e760cd3a689d"},{"fixed":"de40579b903883274fe203865f29d66b168b7236"}]}],"versions":["v6.10","v6.10-rc1","v6.10-rc2","v6.10-rc3","v6.10-rc4","v6.10-rc5","v6.10-rc6","v6.10-rc7","v6.9","v6.9-rc7"],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2024-42256.json","vanir_signatures":[{"deprecated":false,"digest":{"line_hashes":["51308147308004722699998379983511835914","126341825337002368018905416801290899306","63930317229623732413265599070622855231","111464732682824053496901242189520441944","57317592840239935756202389670607321924"],"threshold":0.9},"id":"CVE-2024-42256-22e348bd","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@b1d0a566769b6fb3795b5289fc1daf9e0638d97a","target":{"file":"fs/smb/client/smb2pdu.c"}},{"deprecated":false,"digest":{"function_hash":"97188996608967786147013063464297958604","length":3955},"id":"CVE-2024-42256-f34154f0","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@b1d0a566769b6fb3795b5289fc1daf9e0638d97a","target":{"file":"fs/smb/client/smb2pdu.c","function":"smb2_async_writev"}}]}},{"package":{"name":"Kernel","ecosystem":"Linux"},"ranges":[{"type":"ECOSYSTEM","events":[{"introduced":"6.10.0"},{"fixed":"6.10.1"}]}],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2024-42256.json"}}],"references":[{"type":"PACKAGE","url":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"},{"type":"WEB","url":"https://git.kernel.org/stable/c/b1d0a566769b6fb3795b5289fc1daf9e0638d97a"},{"type":"WEB","url":"https://git.kernel.org/stable/c/de40579b903883274fe203865f29d66b168b7236"}]}