{
  "affected": [
    {
      "database_specific": {
        "source": "https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2024-46687.json",
        "vanir_signatures": [
          {
            "deprecated": false,
            "digest": {
              "line_hashes": [
                "123120924779914774083123435732754717208",
                "257328695233489628573854063352044099233",
                "310598786730578322655699990973500648938",
                "218609255394249866200572385803904697686",
                "131185412947502813617670397425185406114",
                "294603513107070642058921668238494966608",
                "10314124046240786669412739656726768433",
                "115782013066257931876477951347253504240",
                "115038401087442582867051744691141353902",
                "124123144364412525952422926099173504191",
                "190671882770395206835089438789383865640",
                "205884447154858278254973990430419529189",
                "288519367982350097387040847057113305992",
                "214056485947681694241050098635649844633",
                "156497036673323871541840496293344527603",
                "36238450930692862248940709534783315403",
                "315828374618883701490942238502434808471",
                "158497005083312680218938137765894019677",
                "161908278779407149560853165684584836645",
                "1286524880780812726495749895751829962",
                "274259766416565549362416024453230937273",
                "60314389832034052792004323696673775476",
                "254240619396720896940151465141313552257",
                "242485779828307185128381004521424885996",
                "35653888401127334078733682611616056912",
                "50306946681570284688855575154405849447",
                "295348475687964596023396738624181501939"
              ],
              "threshold": 0.9
            },
            "id": "CVE-2024-46687-001f5441",
            "signature_type": "Line",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@4a3b9e1a8e6cd1a8d427a905e159de58d38941cc",
            "target": {
              "file": "fs/btrfs/bio.c"
            }
          },
          {
            "deprecated": false,
            "digest": {
              "function_hash": "304884913410344085724306514830398313983",
              "length": 1849.0
            },
            "id": "CVE-2024-46687-876b3c01",
            "signature_type": "Function",
            "signature_version": "v1",
            "source": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@4a3b9e1a8e6cd1a8d427a905e159de58d38941cc",
            "target": {
              "file": "fs/btrfs/bio.c",
              "function": "btrfs_submit_chunk"
            }
          }
        ]
      },
      "ranges": [
        {
          "events": [
            {
              "introduced": "852eee62d31abd695cd43e1b875d664ed292a8ca"
            },
            {
              "fixed": "51722b99f41f5e722ffa10b8f61e802a0e70b331"
            }
          ],
          "repo": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git",
          "type": "GIT"
        },
        {
          "events": [
            {
              "introduced": "852eee62d31abd695cd43e1b875d664ed292a8ca"
            },
            {
              "fixed": "4a3b9e1a8e6cd1a8d427a905e159de58d38941cc"
            }
          ],
          "repo": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git",
          "type": "GIT"
        },
        {
          "events": [
            {
              "introduced": "852eee62d31abd695cd43e1b875d664ed292a8ca"
            },
            {
              "fixed": "10d9d8c3512f16cad47b2ff81ec6fc4b27d8ee10"
            }
          ],
          "repo": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git",
          "type": "GIT"
        }
      ],
      "versions": [
        "v6.10",
        "v6.10-rc1",
        "v6.10-rc2",
        "v6.10-rc3",
        "v6.10-rc4",
        "v6.10-rc5",
        "v6.10-rc6",
        "v6.10-rc7",
        "v6.10.1",
        "v6.10.2",
        "v6.10.3",
        "v6.10.4",
        "v6.10.5",
        "v6.10.6",
        "v6.10.7",
        "v6.11-rc1",
        "v6.11-rc2",
        "v6.11-rc3",
        "v6.2",
        "v6.3",
        "v6.3-rc1",
        "v6.3-rc2",
        "v6.3-rc3",
        "v6.3-rc4",
        "v6.3-rc5",
        "v6.3-rc6",
        "v6.3-rc7",
        "v6.4",
        "v6.4-rc1",
        "v6.4-rc2",
        "v6.4-rc3",
        "v6.4-rc4",
        "v6.4-rc5",
        "v6.4-rc6",
        "v6.4-rc7",
        "v6.5",
        "v6.5-rc1",
        "v6.5-rc2",
        "v6.5-rc3",
        "v6.5-rc4",
        "v6.5-rc5",
        "v6.5-rc6",
        "v6.5-rc7",
        "v6.6",
        "v6.6-rc1",
        "v6.6-rc2",
        "v6.6-rc3",
        "v6.6-rc4",
        "v6.6-rc5",
        "v6.6-rc6",
        "v6.6-rc7",
        "v6.6.1",
        "v6.6.10",
        "v6.6.11",
        "v6.6.12",
        "v6.6.13",
        "v6.6.14",
        "v6.6.15",
        "v6.6.16",
        "v6.6.17",
        "v6.6.18",
        "v6.6.19",
        "v6.6.2",
        "v6.6.20",
        "v6.6.21",
        "v6.6.22",
        "v6.6.23",
        "v6.6.24",
        "v6.6.25",
        "v6.6.26",
        "v6.6.27",
        "v6.6.28",
        "v6.6.29",
        "v6.6.3",
        "v6.6.30",
        "v6.6.31",
        "v6.6.32",
        "v6.6.33",
        "v6.6.34",
        "v6.6.35",
        "v6.6.36",
        "v6.6.37",
        "v6.6.38",
        "v6.6.39",
        "v6.6.4",
        "v6.6.40",
        "v6.6.41",
        "v6.6.42",
        "v6.6.43",
        "v6.6.44",
        "v6.6.45",
        "v6.6.46",
        "v6.6.47",
        "v6.6.48",
        "v6.6.5",
        "v6.6.6",
        "v6.6.7",
        "v6.6.8",
        "v6.6.9",
        "v6.7",
        "v6.7-rc1",
        "v6.7-rc2",
        "v6.7-rc3",
        "v6.7-rc4",
        "v6.7-rc5",
        "v6.7-rc6",
        "v6.7-rc7",
        "v6.7-rc8",
        "v6.8",
        "v6.8-rc1",
        "v6.8-rc2",
        "v6.8-rc3",
        "v6.8-rc4",
        "v6.8-rc5",
        "v6.8-rc6",
        "v6.8-rc7",
        "v6.9",
        "v6.9-rc1",
        "v6.9-rc2",
        "v6.9-rc3",
        "v6.9-rc4",
        "v6.9-rc5",
        "v6.9-rc6",
        "v6.9-rc7"
      ]
    },
    {
      "database_specific": {
        "source": "https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2024-46687.json"
      },
      "package": {
        "ecosystem": "Linux",
        "name": "Kernel"
      },
      "ranges": [
        {
          "events": [
            {
              "introduced": "6.3.0"
            },
            {
              "fixed": "6.6.49"
            }
          ],
          "type": "ECOSYSTEM"
        },
        {
          "events": [
            {
              "introduced": "6.7.0"
            },
            {
              "fixed": "6.10.8"
            }
          ],
          "type": "ECOSYSTEM"
        }
      ],
      "versions": []
    }
  ],
  "details": "In the Linux kernel, the following vulnerability has been resolved:\n\nbtrfs: fix a use-after-free when hitting errors inside btrfs_submit_chunk()\n\n[BUG]\nThere is an internal report that KASAN is reporting use-after-free, with\nthe following backtrace:\n\n  BUG: KASAN: slab-use-after-free in btrfs_check_read_bio+0xa68/0xb70 [btrfs]\n  Read of size 4 at addr ffff8881117cec28 by task kworker/u16:2/45\n  CPU: 1 UID: 0 PID: 45 Comm: kworker/u16:2 Not tainted 6.11.0-rc2-next-20240805-default+ #76\n  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.2-3-gd478f380-rebuilt.opensuse.org 04/01/2014\n  Workqueue: btrfs-endio btrfs_end_bio_work [btrfs]\n  Call Trace:\n   dump_stack_lvl+0x61/0x80\n   print_address_description.constprop.0+0x5e/0x2f0\n   print_report+0x118/0x216\n   kasan_report+0x11d/0x1f0\n   btrfs_check_read_bio+0xa68/0xb70 [btrfs]\n   process_one_work+0xce0/0x12a0\n   worker_thread+0x717/0x1250\n   kthread+0x2e3/0x3c0\n   ret_from_fork+0x2d/0x70\n   ret_from_fork_asm+0x11/0x20\n\n  Allocated by task 20917:\n   kasan_save_stack+0x37/0x60\n   kasan_save_track+0x10/0x30\n   __kasan_slab_alloc+0x7d/0x80\n   kmem_cache_alloc_noprof+0x16e/0x3e0\n   mempool_alloc_noprof+0x12e/0x310\n   bio_alloc_bioset+0x3f0/0x7a0\n   btrfs_bio_alloc+0x2e/0x50 [btrfs]\n   submit_extent_page+0x4d1/0xdb0 [btrfs]\n   btrfs_do_readpage+0x8b4/0x12a0 [btrfs]\n   btrfs_readahead+0x29a/0x430 [btrfs]\n   read_pages+0x1a7/0xc60\n   page_cache_ra_unbounded+0x2ad/0x560\n   filemap_get_pages+0x629/0xa20\n   filemap_read+0x335/0xbf0\n   vfs_read+0x790/0xcb0\n   ksys_read+0xfd/0x1d0\n   do_syscall_64+0x6d/0x140\n   entry_SYSCALL_64_after_hwframe+0x4b/0x53\n\n  Freed by task 20917:\n   kasan_save_stack+0x37/0x60\n   kasan_save_track+0x10/0x30\n   kasan_save_free_info+0x37/0x50\n   __kasan_slab_free+0x4b/0x60\n   kmem_cache_free+0x214/0x5d0\n   bio_free+0xed/0x180\n   end_bbio_data_read+0x1cc/0x580 [btrfs]\n   btrfs_submit_chunk+0x98d/0x1880 [btrfs]\n   btrfs_submit_bio+0x33/0x70 [btrfs]\n   submit_one_bio+0xd4/0x130 [btrfs]\n   submit_extent_page+0x3ea/0xdb0 [btrfs]\n   btrfs_do_readpage+0x8b4/0x12a0 [btrfs]\n   btrfs_readahead+0x29a/0x430 [btrfs]\n   read_pages+0x1a7/0xc60\n   page_cache_ra_unbounded+0x2ad/0x560\n   filemap_get_pages+0x629/0xa20\n   filemap_read+0x335/0xbf0\n   vfs_read+0x790/0xcb0\n   ksys_read+0xfd/0x1d0\n   do_syscall_64+0x6d/0x140\n   entry_SYSCALL_64_after_hwframe+0x4b/0x53\n\n[CAUSE]\nAlthough I cannot reproduce the error, the report itself is good enough\nto pin down the cause.\n\nThe call trace is the regular endio workqueue context, but the\nfree-by-task trace is showing that during btrfs_submit_chunk() we\nalready hit a critical error, and is calling btrfs_bio_end_io() to error\nout.  And the original endio function called bio_put() to free the whole\nbio.\n\nThis means a double freeing thus causing use-after-free, e.g.:\n\n1. Enter btrfs_submit_bio() with a read bio\n   The read bio length is 128K, crossing two 64K stripes.\n\n2. The first run of btrfs_submit_chunk()\n\n2.1 Call btrfs_map_block(), which returns 64K\n2.2 Call btrfs_split_bio()\n    Now there are two bios, one referring to the first 64K, the other\n    referring to the second 64K.\n2.3 The first half is submitted.\n\n3. The second run of btrfs_submit_chunk()\n\n3.1 Call btrfs_map_block(), which by somehow failed\n    Now we call btrfs_bio_end_io() to handle the error\n\n3.2 btrfs_bio_end_io() calls the original endio function\n    Which is end_bbio_data_read(), and it calls bio_put() for the\n    original bio.\n\n    Now the original bio is freed.\n\n4. The submitted first 64K bio finished\n   Now we call into btrfs_check_read_bio() and tries to advance the bio\n   iter.\n   But since the original bio (thus its iter) is already freed, we\n   trigger the above use-after free.\n\n   And even if the memory is not poisoned/corrupted, we will later call\n   the original endio function, causing a double freeing.\n\n[FIX]\nInstead of calling btrfs_bio_end_io(), call btrfs_orig_bbio_end_io(),\nwhich has the extra check on split bios and do the pr\n---truncated---",
  "id": "CVE-2024-46687",
  "modified": "2025-10-15T14:48:23.291003Z",
  "published": "2024-09-13T05:29:18Z",
  "references": [
    {
      "type": "PACKAGE",
      "url": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"
    },
    {
      "type": "WEB",
      "url": "https://git.kernel.org/stable/c/10d9d8c3512f16cad47b2ff81ec6fc4b27d8ee10"
    },
    {
      "type": "WEB",
      "url": "https://git.kernel.org/stable/c/4a3b9e1a8e6cd1a8d427a905e159de58d38941cc"
    },
    {
      "type": "WEB",
      "url": "https://git.kernel.org/stable/c/51722b99f41f5e722ffa10b8f61e802a0e70b331"
    }
  ],
  "related": [
    "SUSE-SU-2024:3551-1",
    "SUSE-SU-2024:3553-1",
    "SUSE-SU-2024:3561-1",
    "SUSE-SU-2024:3564-1"
  ],
  "schema_version": "1.7.3",
  "summary": "btrfs: fix a use-after-free when hitting errors inside btrfs_submit_chunk()"
}