{"schema_version":"1.7.3","id":"CVE-2022-49079","published":"2025-02-26T01:54:40Z","modified":"2025-10-21T08:56:35.574574Z","summary":"btrfs: zoned: traverse devices under chunk_mutex in btrfs_can_activate_zone","details":"In the Linux kernel, the following vulnerability has been resolved:\n\nbtrfs: zoned: traverse devices under chunk_mutex in btrfs_can_activate_zone\n\nbtrfs_can_activate_zone() can be called with the device_list_mutex already\nheld, which will lead to a deadlock:\n\ninsert_dev_extents() // Takes device_list_mutex\n`-> insert_dev_extent()\n `-> btrfs_insert_empty_item()\n  `-> btrfs_insert_empty_items()\n   `-> btrfs_search_slot()\n    `-> btrfs_cow_block()\n     `-> __btrfs_cow_block()\n      `-> btrfs_alloc_tree_block()\n       `-> btrfs_reserve_extent()\n        `-> find_free_extent()\n         `-> find_free_extent_update_loop()\n          `-> can_allocate_chunk()\n           `-> btrfs_can_activate_zone() // Takes device_list_mutex again\n\nInstead of using the RCU on fs_devices->device_list we\ncan use fs_devices->alloc_list, protected by the chunk_mutex to traverse\nthe list of active devices.\n\nWe are in the chunk allocation thread. The newer chunk allocation\nhappens from the devices in the fs_device->alloc_list protected by the\nchunk_mutex.\n\n  btrfs_create_chunk()\n    lockdep_assert_held(&info->chunk_mutex);\n    gather_device_info\n      list_for_each_entry(device, &fs_devices->alloc_list, dev_alloc_list)\n\nAlso, a device that reappears after the mount won't join the alloc_list\nyet and, it will be in the dev_list, which we don't want to consider in\nthe context of the chunk alloc.\n\n  [15.166572] WARNING: possible recursive locking detected\n  [15.167117] 5.17.0-rc6-dennis #79 Not tainted\n  [15.167487] --------------------------------------------\n  [15.167733] kworker/u8:3/146 is trying to acquire lock:\n  [15.167733] ffff888102962ee0 (&fs_devs->device_list_mutex){+.+.}-{3:3}, at: find_free_extent+0x15a/0x14f0 [btrfs]\n  [15.167733]\n  [15.167733] but task is already holding lock:\n  [15.167733] ffff888102962ee0 (&fs_devs->device_list_mutex){+.+.}-{3:3}, at: btrfs_create_pending_block_groups+0x20a/0x560 [btrfs]\n  [15.167733]\n  [15.167733] other info that might help us debug this:\n  [15.167733]  Possible unsafe locking scenario:\n  [15.167733]\n  [15.171834]        CPU0\n  [15.171834]        ----\n  [15.171834]   lock(&fs_devs->device_list_mutex);\n  [15.171834]   lock(&fs_devs->device_list_mutex);\n  [15.171834]\n  [15.171834]  *** DEADLOCK ***\n  [15.171834]\n  [15.171834]  May be due to missing lock nesting notation\n  [15.171834]\n  [15.171834] 5 locks held by kworker/u8:3/146:\n  [15.171834]  #0: ffff888100050938 ((wq_completion)events_unbound){+.+.}-{0:0}, at: process_one_work+0x1c3/0x5a0\n  [15.171834]  #1: ffffc9000067be80 ((work_completion)(&fs_info->async_data_reclaim_work)){+.+.}-{0:0}, at: process_one_work+0x1c3/0x5a0\n  [15.176244]  #2: ffff88810521e620 (sb_internal){.+.+}-{0:0}, at: flush_space+0x335/0x600 [btrfs]\n  [15.176244]  #3: ffff888102962ee0 (&fs_devs->device_list_mutex){+.+.}-{3:3}, at: btrfs_create_pending_block_groups+0x20a/0x560 [btrfs]\n  [15.176244]  #4: ffff8881152e4b78 (btrfs-dev-00){++++}-{3:3}, at: __btrfs_tree_lock+0x27/0x130 [btrfs]\n  [15.179641]\n  [15.179641] stack backtrace:\n  [15.179641] CPU: 1 PID: 146 Comm: kworker/u8:3 Not tainted 5.17.0-rc6-dennis #79\n  [15.179641] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1.fc35 04/01/2014\n  [15.179641] Workqueue: events_unbound btrfs_async_reclaim_data_space [btrfs]\n  [15.179641] Call Trace:\n  [15.179641]  <TASK>\n  [15.179641]  dump_stack_lvl+0x45/0x59\n  [15.179641]  __lock_acquire.cold+0x217/0x2b2\n  [15.179641]  lock_acquire+0xbf/0x2b0\n  [15.183838]  ? find_free_extent+0x15a/0x14f0 [btrfs]\n  [15.183838]  __mutex_lock+0x8e/0x970\n  [15.183838]  ? find_free_extent+0x15a/0x14f0 [btrfs]\n  [15.183838]  ? find_free_extent+0x15a/0x14f0 [btrfs]\n  [15.183838]  ? lock_is_held_type+0xd7/0x130\n  [15.183838]  ? find_free_extent+0x15a/0x14f0 [btrfs]\n  [15.183838]  find_free_extent+0x15a/0x14f0 [btrfs]\n  [15.183838]  ? _raw_spin_unlock+0x24/0x40\n  [15.183838]  ? btrfs_get_alloc_profile+0x106/0x230 [btrfs]\n  [15.187601]  btrfs_reserve_extent+0x131/0x260 [btrfs]\n  [15.\n---truncated---","affected":[{"ranges":[{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"a85f05e59bc15a83ad910dbcb71df5ad8fa77295"},{"fixed":"09e65ae515af2b24d6dc23af21719a3b41de83e5"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"a85f05e59bc15a83ad910dbcb71df5ad8fa77295"},{"fixed":"142f822bd945a7be442a2916ec6167cc102c4183"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"a85f05e59bc15a83ad910dbcb71df5ad8fa77295"},{"fixed":"0b9e66762aa0cda2a9c2d5542d64e04dac528fa6"}]}],"versions":["v5.15","v5.16","v5.16-rc1","v5.16-rc2","v5.16-rc3","v5.16-rc4","v5.16-rc5","v5.16-rc6","v5.16-rc7","v5.16-rc8","v5.16.1","v5.16.10","v5.16.11","v5.16.12","v5.16.13","v5.16.14","v5.16.15","v5.16.16","v5.16.17","v5.16.18","v5.16.19","v5.16.2","v5.16.3","v5.16.4","v5.16.5","v5.16.6","v5.16.7","v5.16.8","v5.16.9","v5.17","v5.17-rc1","v5.17-rc2","v5.17-rc3","v5.17-rc4","v5.17-rc5","v5.17-rc6","v5.17-rc7","v5.17-rc8","v5.17.1","v5.17.2"],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2022-49079.json","vanir_signatures":[{"deprecated":false,"digest":{"function_hash":"131036999475384526096197465044058802293","length":531},"id":"CVE-2022-49079-07e7bdad","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@0b9e66762aa0cda2a9c2d5542d64e04dac528fa6","target":{"file":"fs/btrfs/zoned.c","function":"btrfs_can_activate_zone"}},{"deprecated":false,"digest":{"function_hash":"131036999475384526096197465044058802293","length":531},"id":"CVE-2022-49079-1bb4d159","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@09e65ae515af2b24d6dc23af21719a3b41de83e5","target":{"file":"fs/btrfs/zoned.c","function":"btrfs_can_activate_zone"}},{"deprecated":false,"digest":{"function_hash":"131036999475384526096197465044058802293","length":531},"id":"CVE-2022-49079-1fb5e5f3","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@142f822bd945a7be442a2916ec6167cc102c4183","target":{"file":"fs/btrfs/zoned.c","function":"btrfs_can_activate_zone"}},{"deprecated":false,"digest":{"line_hashes":["49402861227911255323150303528515554599","76485764690462993539776006086504841775","13418353629997599088078993074220523662","296505339228934724182760359673582867016","251441205606494138900734880397781508498","176069995675299456077269991537901161330","148985049326667601174236984613803260412","308649089074024301086823756088218473936","210745332495611155341461685013417095852","182316827707737227387969186288741164983","50068267094916447304361663731240708143","88262129946607204590758826713607231001","239018909023108806580357973267172404906","59377181314647630251567152808686493159","34633943432884081473582246690027189373"],"threshold":0.9},"id":"CVE-2022-49079-204931e7","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@142f822bd945a7be442a2916ec6167cc102c4183","target":{"file":"fs/btrfs/zoned.c"}},{"deprecated":false,"digest":{"line_hashes":["273447731240792755413569821963861990322","76485764690462993539776006086504841775","13418353629997599088078993074220523662","296505339228934724182760359673582867016","251441205606494138900734880397781508498","176069995675299456077269991537901161330","148985049326667601174236984613803260412","308649089074024301086823756088218473936","210745332495611155341461685013417095852","182316827707737227387969186288741164983","50068267094916447304361663731240708143","88262129946607204590758826713607231001","239018909023108806580357973267172404906","59377181314647630251567152808686493159","34633943432884081473582246690027189373"],"threshold":0.9},"id":"CVE-2022-49079-29c51daf","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@0b9e66762aa0cda2a9c2d5542d64e04dac528fa6","target":{"file":"fs/btrfs/zoned.c"}},{"deprecated":false,"digest":{"line_hashes":["49402861227911255323150303528515554599","76485764690462993539776006086504841775","13418353629997599088078993074220523662","296505339228934724182760359673582867016","251441205606494138900734880397781508498","176069995675299456077269991537901161330","148985049326667601174236984613803260412","308649089074024301086823756088218473936","210745332495611155341461685013417095852","182316827707737227387969186288741164983","50068267094916447304361663731240708143","88262129946607204590758826713607231001","239018909023108806580357973267172404906","59377181314647630251567152808686493159","34633943432884081473582246690027189373"],"threshold":0.9},"id":"CVE-2022-49079-2b28989f","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@09e65ae515af2b24d6dc23af21719a3b41de83e5","target":{"file":"fs/btrfs/zoned.c"}}]}},{"package":{"name":"Kernel","ecosystem":"Linux"},"ranges":[{"type":"ECOSYSTEM","events":[{"introduced":"5.16.0"},{"fixed":"5.16.20"}]},{"type":"ECOSYSTEM","events":[{"introduced":"5.17.0"},{"fixed":"5.17.3"}]}],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2022-49079.json"}}],"references":[{"type":"PACKAGE","url":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"},{"type":"WEB","url":"https://git.kernel.org/stable/c/09e65ae515af2b24d6dc23af21719a3b41de83e5"},{"type":"WEB","url":"https://git.kernel.org/stable/c/0b9e66762aa0cda2a9c2d5542d64e04dac528fa6"},{"type":"WEB","url":"https://git.kernel.org/stable/c/142f822bd945a7be442a2916ec6167cc102c4183"}]}