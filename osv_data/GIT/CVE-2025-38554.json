{"schema_version":"1.7.3","id":"CVE-2025-38554","published":"2025-08-19T17:02:33.315Z","modified":"2025-11-20T09:35:02.571181Z","summary":"mm: fix a UAF when vma->mm is freed after vma->vm_refcnt got dropped","details":"In the Linux kernel, the following vulnerability has been resolved:\n\nmm: fix a UAF when vma->mm is freed after vma->vm_refcnt got dropped\n\nBy inducing delays in the right places, Jann Horn created a reproducer for\na hard to hit UAF issue that became possible after VMAs were allowed to be\nrecycled by adding SLAB_TYPESAFE_BY_RCU to their cache.\n\nRace description is borrowed from Jann's discovery report:\nlock_vma_under_rcu() looks up a VMA locklessly with mas_walk() under\nrcu_read_lock().  At that point, the VMA may be concurrently freed, and it\ncan be recycled by another process.  vma_start_read() then increments the\nvma->vm_refcnt (if it is in an acceptable range), and if this succeeds,\nvma_start_read() can return a recycled VMA.\n\nIn this scenario where the VMA has been recycled, lock_vma_under_rcu()\nwill then detect the mismatching ->vm_mm pointer and drop the VMA through\nvma_end_read(), which calls vma_refcount_put().  vma_refcount_put() drops\nthe refcount and then calls rcuwait_wake_up() using a copy of vma->vm_mm. \nThis is wrong: It implicitly assumes that the caller is keeping the VMA's\nmm alive, but in this scenario the caller has no relation to the VMA's mm,\nso the rcuwait_wake_up() can cause UAF.\n\nThe diagram depicting the race:\nT1         T2         T3\n==         ==         ==\nlock_vma_under_rcu\n  mas_walk\n          <VMA gets removed from mm>\n                      mmap\n                        <the same VMA is reallocated>\n  vma_start_read\n    __refcount_inc_not_zero_limited_acquire\n                      munmap\n                        __vma_enter_locked\n                          refcount_add_not_zero\n  vma_end_read\n    vma_refcount_put\n      __refcount_dec_and_test\n                          rcuwait_wait_event\n                            <finish operation>\n      rcuwait_wake_up [UAF]\n\nNote that rcuwait_wait_event() in T3 does not block because refcount was\nalready dropped by T1.  At this point T3 can exit and free the mm causing\nUAF in T1.\n\nTo avoid this we move vma->vm_mm verification into vma_start_read() and\ngrab vma->vm_mm to stabilize it before vma_refcount_put() operation.\n\n[surenb@google.com: v3]","affected":[{"ranges":[{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"3104138517fc66aad21f4a2487bb572e9fc2e3ec"},{"fixed":"6e88fe54721dee17d3496bc998f0c7d243896348"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"3104138517fc66aad21f4a2487bb572e9fc2e3ec"},{"fixed":"1bcd236a2536a451e385f8d6d2bb589689ec812f"}]},{"type":"GIT","repo":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git","events":[{"introduced":"3104138517fc66aad21f4a2487bb572e9fc2e3ec"},{"fixed":"9bbffee67ffd16360179327b57f3b1245579ef08"}]}],"versions":["v6.14","v6.14-rc7","v6.15","v6.15-rc1","v6.15-rc2","v6.15-rc3","v6.15-rc4","v6.15-rc5","v6.15-rc6","v6.15-rc7","v6.15.1","v6.15.2","v6.15.3","v6.15.4","v6.15.5","v6.15.6","v6.15.7","v6.15.8","v6.15.9","v6.16","v6.16-rc1","v6.16-rc2","v6.16-rc3","v6.16-rc4","v6.16-rc5","v6.16-rc6","v6.16-rc7"],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2025-38554.json","vanir_signatures":[{"deprecated":false,"digest":{"line_hashes":["258877343943662830856697068793982500732","73965373887887266527835179776982886953","133614014280599669384608609310779216921","305664576120995624970854514274596645627","181558845151977304656870377115790360350","152180957025052269741558762378359882025","168508196780366090636966157346003367285","286967154390907846390046454146957142707","141516510164057740229748684300777085542","201938151910499564575890903686338821110","178411234689734073879989585356791880134"],"threshold":0.9},"id":"CVE-2025-38554-59a4d4c5","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1bcd236a2536a451e385f8d6d2bb589689ec812f","target":{"file":"include/linux/mmap_lock.h"}},{"deprecated":false,"digest":{"function_hash":"299215882656078776674997873086707367633","length":505},"id":"CVE-2025-38554-69f42ded","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1bcd236a2536a451e385f8d6d2bb589689ec812f","target":{"file":"include/linux/mmap_lock.h","function":"vma_start_read"}},{"deprecated":false,"digest":{"function_hash":"165915473331966525814706527873613675458","length":609},"id":"CVE-2025-38554-8e0e494a","signature_type":"Function","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1bcd236a2536a451e385f8d6d2bb589689ec812f","target":{"file":"mm/mmap_lock.c","function":"lock_vma_under_rcu"}},{"deprecated":false,"digest":{"line_hashes":["294013302982920204037913566028016014251","159015120150196900455887933993808534966","2137947755218393236345347746715871539","336265446854873021584330943732366462387","89767516992678547624192936917745781516"],"threshold":0.9},"id":"CVE-2025-38554-a36cb100","signature_type":"Line","signature_version":"v1","source":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git@1bcd236a2536a451e385f8d6d2bb589689ec812f","target":{"file":"mm/mmap_lock.c"}}]}},{"package":{"name":"Kernel","ecosystem":"Linux"},"ranges":[{"type":"ECOSYSTEM","events":[{"introduced":"6.15.0"},{"fixed":"6.15.10"}]},{"type":"ECOSYSTEM","events":[{"introduced":"6.16.0"},{"fixed":"6.16.1"}]}],"database_specific":{"source":"https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2025-38554.json"}}],"references":[{"type":"PACKAGE","url":"https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"},{"type":"WEB","url":"https://git.kernel.org/stable/c/1bcd236a2536a451e385f8d6d2bb589689ec812f"},{"type":"WEB","url":"https://git.kernel.org/stable/c/6e88fe54721dee17d3496bc998f0c7d243896348"},{"type":"WEB","url":"https://git.kernel.org/stable/c/9bbffee67ffd16360179327b57f3b1245579ef08"}]}